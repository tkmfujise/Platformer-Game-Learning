---
title: src/chapters/0/stages/0/stage_0.tscn
---
:toc:

== src / chapters / 0 / stages / 0 / stage_0.tscn

=== Diagram
[plantuml]
....
class R as "Stage0" <<(C,lightgreen) Control>> {
---
  + restart()
  + _on_player_failed()
  + _on_restart_curtain_animation_finished()
}
class N1 as "CanvasLayer" <<(C,yellow) CanvasLayer>> {
}
class N2 as "OpeningCurtain" <<(C,lightgreen) Control>> {
  ~ animation_finished
---
  * pattern
  * center
---
  + set_center()
  + play()
  + _on_animation_player_animation_finished()
}
class N3 as "RestartCurtain" <<(C,lightgreen) Control>> {
  ~ animation_finished
---
  * pattern
  * center
---
  + set_center()
  + play()
  + _on_animation_player_animation_finished()
}
class N4 as "ColorRect" <<(C,lightgreen) ColorRect>> {
}
class N5 as "Forest" <<(N,lightskyblue) Node2D>> {
}
class N6 as "Frames" <<(N,lightskyblue) Node2D>> {
}
class N7 as "CameralFrame" <<(A,lightskyblue) Area2D>> {
  - HALF_SIZE
---
  + corner()
}
class N8 as "CameraFrame2" <<(A,lightskyblue) Area2D>> {
  - HALF_SIZE
---
  + corner()
}
class N9 as "CameraFrame3" <<(A,lightskyblue) Area2D>> {
  - HALF_SIZE
---
  + corner()
}
class N10 as "StageGround0" <<(T,yellow) TileMapLayer>> {
}
class N11 as "Gimmicks" <<(N,lightskyblue) Node2D>> {
}
class N12 as "FallingIceBlock" <<(R,lightskyblue) RigidBody2D>> {
---
  + _ready()
  + _process()
  + fall()
  + _on_detection_area_2d_body_entered()
}
class N13 as "Player" <<(C,lightskyblue) CharacterBody2D>> {
  ~ dashed
  ~ failed
---
  - SPEED
  - DASH_SPEED
  - JUMP_VELOCITY
  - GRAVITY
  - ALLOWED_TIME_TO_JUMP
  - DASH_TIME
  - DASH_ATTENUATION
  - MAX_DASH_COUNT
  * GhostEffect
  * falling_time
  * dash_rest_time
  * dash_rest_count
  * grounding
  * is_failed
---
  + _ready()
  + _physics_process()
  + animate()
  + vibrate()
  + get_state()
  + update_sprite_states_shader_parameters()
  + spawn_ghost_effect()
  + current_sprite_state()
  + is_dashed()
  + _on_dashed()
  + _on_failed()
  + _on_frame_subject_area_entered()
  + _on_frame_subject_area_exited()
  + _on_failure_collision_area_entered()
}
class N14 as "Weather" <<(N,lightskyblue) Node2D>> {
---
  + _process()
  + current_camera()
}
class N15 as "AnimationPlayer" <<(A,yellow) AnimationPlayer>> {
}
R --o N1
R --o N4
R --o N5
R --o N6
R --o N10
R --o N11
R --o N13
R --o N14
R --o N15
N1 --o N2
N1 --o N3
N6 --o N7
N6 --o N8
N6 --o N9
N11 --o N12
!define _(a,b) a <-[#blue,thickness=2]- b
left to right direction
_(R::_on_restart_curtain_animation_finished, N3::animation_finished)
_(R::_on_player_failed, N13::failed)
....




=== Overridden virtual functions
==== _ready
.$Gimmicks/FallingIceBlock
```gdscript
func _ready() -> void:
	freeze = true
```
.$Player
```gdscript
func _ready() -> void:
	is_failed = false
```
==== _process
.$Gimmicks/FallingIceBlock
```gdscript
func _process(_delta: float) -> void:
	if Player.is_failed: freeze = true
```
.$Weather
```gdscript
func _process(_delta: float) -> void:
	var camera = current_camera()
	if camera: global_position = camera.global_position
```
==== _physics_process
.$Player
```gdscript
func _physics_process(delta: float) -> void:
	if is_failed:
		return
	if dash_rest_time > 0:
		dash_rest_time -= delta
		velocity *= DASH_ATTENUATION * delta
	else:
		# Add the gravity.
		if not is_on_floor():
			velocity.y += GRAVITY * delta
			falling_time += delta
			grounding = false
		else:
			if not grounding: vibrate('Landed')
			grounding = true
			falling_time = 0
			dash_rest_count = MAX_DASH_COUNT

		# Handle jump.
		if Input.is_action_just_pressed("move_jump") and falling_time < ALLOWED_TIME_TO_JUMP:
			velocity.y = JUMP_VELOCITY

		var direction_x := Input.get_axis("move_left", "move_right")
		if direction_x:
			velocity.x = direction_x * SPEED
		else:
			velocity.x = move_toward(velocity.x, 0, SPEED)

		# Handle dash.
		if Input.is_action_just_pressed("move_dash") && dash_rest_count > 0:
			var direction_y := Input.get_axis("move_up", "move_down")
			var direction = Vector2(direction_x, direction_y).normalized()
			if direction:
				dashed.emit()
				velocity = direction * DASH_SPEED
				dash_rest_time = DASH_TIME
				dash_rest_count -= 1
	animate()
	move_and_slide()
```


=== Instantiators
CAUTION: No other scene instantiate this scene.

=== Scene Tree
[.scene-tree]
* [.node-name.type-control]#Stage0# [.node-type.type-control]#Control#
** [.node-name.type-other]#CanvasLayer# [.node-type.type-other]#CanvasLayer#
*** [.node-name.type-control]#OpeningCurtain# [.node-type.type-control]#link:/scenes/src/curtain/opening/opening.tscn[res://src/curtain/opening/opening.tscn]#
*** [.node-name.type-control]#RestartCurtain# [.node-type.type-control]#link:/scenes/src/curtain/opening/opening.tscn[res://src/curtain/opening/opening.tscn]#
** [.node-name.type-control]#ColorRect# [.node-type.type-control]#ColorRect#
** [.node-name.type-2d]#Forest# [.node-type.type-2d]#link:/scenes/src/stages/background/forest/forest.tscn[res://src/stages/background/forest/forest.tscn]#
** [.node-name.type-2d]#Frames# [.node-type.type-2d]#Node2D#
*** [.node-name.type-2d]#CameralFrame# [.node-type.type-2d]#link:/scenes/src/stages/frame/camera_frame.tscn[res://src/stages/frame/camera_frame.tscn]#
*** [.node-name.type-2d]#CameraFrame2# [.node-type.type-2d]#link:/scenes/src/stages/frame/camera_frame.tscn[res://src/stages/frame/camera_frame.tscn]#
*** [.node-name.type-2d]#CameraFrame3# [.node-type.type-2d]#link:/scenes/src/stages/frame/camera_frame.tscn[res://src/stages/frame/camera_frame.tscn]#
** [.node-name.type-other]#StageGround0# [.node-type.type-other]#link:/scenes/src/stages/0/staege_ground_0.tscn[res://src/stages/0/staege_ground_0.tscn]#
** [.node-name.type-2d]#Gimmicks# [.node-type.type-2d]#Node2D#
*** [.node-name.type-2d]#FallingIceBlock# [.node-type.type-2d]#link:/scenes/src/stages/gimmicks/falling_ice_block/falling_ice_block.tscn[res://src/stages/gimmicks/falling_ice_block/falling_ice_block.tscn]#
** [.node-name.type-2d]#Player# [.node-type.type-2d]#link:/scenes/src/player/player.tscn[res://src/player/player.tscn]#
** [.node-name.type-2d]#Weather# [.node-type.type-2d]#link:/scenes/src/stages/weather/weather.tscn[res://src/stages/weather/weather.tscn]#
** [.node-name.type-other]#AnimationPlayer# [.node-type.type-other]#AnimationPlayer#


=== Signal Connections
[.signal-connection]
.$CanvasLayer/RestartCurtain:[#_animation_finished_#]=>$.
```gdscript
func _on_restart_curtain_animation_finished() -> void:
	restart()
```
[.signal-connection]
.$Player:[#_failed_#]=>$.
```gdscript
func _on_player_failed() -> void:
	await get_tree().create_timer(2).timeout
	%RestartCurtain.play()
```


=== Animations
==== opening (autoplay)

[plantuml]
....
control "Root" as R
participant "$CanvasLayer\n/OpeningCurtain" as T0 #90EE90



== Time: 0.0 ==
R  ->o  T0 : &"play"()


....
---



=== Properties
[.node-property.node-control]
.#Root# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*layout_mode* a|`3`
|*anchors_preset* a|`15`
|*anchor_right* a|`1.0`
|*anchor_bottom* a|`1.0`
|*grow_horizontal* a|`2`
|*grow_vertical* a|`2`
|*script* a|link:/scripts/src/chapters/0/stages/0/stage_0.gd[res://src/chapters/0/stages/0/stage_0.gd]
|===
[.node-property.node-control]
.#$CanvasLayer/OpeningCurtain# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*unique_name_in_owner* a|`true`
|*pattern* a|`1`
|*center* a|`Vector2(0.3, 0.6)`
|===
[.node-property.node-control]
.#$CanvasLayer/RestartCurtain# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*unique_name_in_owner* a|`true`
|*pattern* a|`3`
|===
[.node-property.node-control]
.#$ColorRect# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*layout_mode* a|`1`
|*anchors_preset* a|`15`
|*anchor_right* a|`1.0`
|*anchor_bottom* a|`1.0`
|*offset_top* a|`-2073.0`
|*offset_right* a|`5082.0`
|*grow_horizontal* a|`2`
|*grow_vertical* a|`2`
|*color* a|`Color(0.066755, 0.066755, 0.066755, 1)`
|===
[.node-property.node-2d]
.#$Frames/CameralFrame# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*position* a|`Vector2(960, 540)`
|===
[.node-property.node-2d]
.#$Frames/CameraFrame2# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*position* a|`Vector2(1895, 540)`
|===
[.node-property.node-2d]
.#$Frames/CameraFrame3# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*position* a|`Vector2(3824, 547)`
|===
[.node-property.node-other]
.#$StageGround0# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*tile_map_data* a|`PackedByteArray("AAAKAAkAAAACAAAAAAAJAAoAAAAEAAEAAAAJAAsAAAAEAAEAAAAJAAkAAAABAAAAAAAIAAkAAAADAAAAAAAAAAoAAAAEAAAAAAABAAoAAAAEAAAAAAACAAoAAAAEAAAAAAADAAoAAAAEAAAAAAAEAAoAAAAEAAAAAAAFAAoAAAAEAAAAAAAGAAoAAAAEAAAAAAAHAAoAAAABAAAAAAAIAAoAAAABAAAAAAAIAAsAAAAEAAEAAAAHAAsAAAAEAAEAAAAGAAsAAAAEAAEAAAAFAAsAAAAEAAEAAAAEAAsAAAAEAAEAAAADAAsAAAAEAAEAAAACAAsAAAAEAAEAAAABAAsAAAAEAAEAAAAAAAsAAAAEAAEAAAAOAAsAAAADAAAAAAASAAsAAAAFAAAAAAARAAkAAAAFAAAAAAAQAAoAAAADAAEAAAAQAAkAAAADAAAAAAAPAAsAAAAEAAAAAAAQAAsAAAAEAAAAAAARAAsAAAAEAAEAAAARAAoAAAAFAAEAAAAOAAwAAAADAAEAAAAOAA0AAAADAAEAAAAPAAwAAAAEAAEAAAAPAA0AAAAEAAEAAAAQAAwAAAAEAAEAAAAQAA0AAAAEAAEAAAARAAwAAAAEAAEAAAARAA0AAAAEAAEAAAASAAwAAAAFAAEAAAASAA0AAAAFAAEAAAAAAAwAAAAEAAEAAAABAAwAAAAEAAEAAAACAAwAAAAEAAEAAAADAAwAAAAEAAEAAAAEAAwAAAAEAAEAAAAFAAwAAAAEAAEAAAAGAAwAAAAEAAEAAAAHAAwAAAAEAAEAAAAIAAwAAAAEAAEAAAAJAAwAAAACAAEAAAAKAAoAAAACAAEAAAAAAA0AAAAEAAEAAAABAA0AAAAEAAEAAAACAA0AAAAEAAEAAAADAA0AAAAEAAEAAAAEAA0AAAAEAAEAAAAFAA0AAAAEAAEAAAAGAA0AAAAEAAEAAAAHAA0AAAAEAAEAAAAIAA0AAAAEAAEAAAAJAA0AAAACAAEAAAAKAAsAAAACAAIAAAASAP7/AAAEAAAAAAASAP//AAAEAAEAAAASAAAAAAAEAAEAAAASAAEAAAAFAAIAAAATAP7/AAAEAAAAAAATAP//AAAEAAEAAAAUAP7/AAAEAAAAAAAUAP//AAAEAAEAAAAUAAAAAAAEAAIAAAAVAP7/AAAEAAAAAAAVAP//AAAEAAEAAAAVAAAAAAAEAAEAAAAWAP7/AAAEAAAAAAAWAP//AAAEAAEAAAAWAAAAAAAEAAEAAAAXAP7/AAAEAAAAAAAXAP//AAAEAAEAAAAXAAAAAAAEAAEAAAAYAP7/AAAEAAAAAAAYAP//AAAEAAEAAAAYAAAAAAAEAAEAAAAZAP7/AAAFAAAAAAAZAP//AAAEAAEAAAAZAAAAAAAEAAEAAAARAP7/AAADAAAAAAARAP//AAADAAEAAAARAAAAAAADAAEAAAARAAEAAAADAAIAAAAWAAoAAAAEAAAAAAAWAAsAAAAEAAEAAAAXAAoAAAAEAAAAAAAXAAsAAAAEAAEAAAAXAAwAAAAEAAEAAAAXAA0AAAAEAAEAAAAYAAoAAAAEAAAAAAAYAAsAAAAEAAEAAAAYAAwAAAAFAAEAAAAYAA0AAAAFAAEAAAAZAAoAAAAFAAAAAAAZAAsAAAAFAAIAAAAVAAoAAAADAAAAAAAVAAsAAAADAAIAAAAWAAwAAAADAAEAAAAWAA0AAAADAAEAAAANAAMAAAADAAAAAAANAAQAAAADAAIAAAAOAAMAAAAFAAAAAAAOAAQAAAAFAAIAAAAUAAEAAAAAAAIAAAAVAAEAAAABAAEAAAAVAAIAAAAAAAIAAAAWAAEAAAABAAEAAAAWAAIAAAABAAIAAAAXAAEAAAABAAEAAAAXAAIAAAABAAIAAAAYAAEAAAAEAAEAAAAYAAIAAAABAAIAAAAZAAEAAAAFAAEAAAAZAAIAAAACAAIAAAATAAAAAAAEAAIAAAAaAAAAAAAFAAIAAAAaAP//AAAEAAEAAAAbAP//AAAFAAIAAAAbAP7/AAAFAAAAAAAaAP7/AAAEAAAAAAAdAAwAAAADAAAAAAAdAA0AAAADAAIAAAAeAAwAAAABAAAAAAAeAA0AAAAEAAEAAAAfAAoAAAADAAAAAAAfAAsAAAADAAEAAAAfAAwAAAADAAEAAAAfAA0AAAAEAAEAAAAgAAoAAAAFAAAAAAAgAAsAAAAFAAEAAAAgAAwAAAAFAAEAAAAgAA0AAAAFAAIAAAAjAAwAAAAEAAAAAAAjAA0AAAAEAAEAAAAkAAwAAAAEAAAAAAAkAA0AAAAEAAEAAAAlAAwAAAAEAAAAAAAmAAwAAAAEAAAAAAAnAAwAAAAEAAAAAAAoAAwAAAAEAAAAAAAiAAwAAAADAAAAAAAiAA0AAAADAAIAAAA=")`
|===
[.node-property.node-2d]
.#$Gimmicks/FallingIceBlock# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*position* a|`Vector2(1882, 332)`
|===
[.node-property.node-2d]
.#$Player# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*unique_name_in_owner* a|`true`
|*position* a|`Vector2(328, 284)`
|===
[.node-property.node-other]
.#$AnimationPlayer# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*unique_name_in_owner* a|`true`
|*libraries* a|`{
&"": SubResource("AnimationLibrary_arpf2")
}`
|*autoplay* a|`opening`
|===


=== link:/scripts/src/chapters/0/stages/0/stage_0.gd[stage_0.gd]

```gdscript
extends Control


func restart() -> void:
	get_tree().reload_current_scene()


func _on_player_failed() -> void:
	await get_tree().create_timer(2).timeout
	%RestartCurtain.play()


func _on_restart_curtain_animation_finished() -> void:
	restart()

```


