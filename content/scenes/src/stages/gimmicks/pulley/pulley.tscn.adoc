---
title: src/stages/gimmicks/pulley/pulley.tscn
---
:toc:

== src / stages / gimmicks / pulley / pulley.tscn

=== Diagram
[plantuml]
....
class R as "Pulley" <<(N,lightskyblue) Node2D>> {
  * state
  * force
  * player
  * prev_position
---
  + _ready()
  + set_prev_position()
  + _physics_process()
  + reset()
  + move()
  + rewind()
  + launchable()
  + unlaunchable()
  + play()
  + _on_area_2d_area_entered()
  + _on_area_2d_area_exited()
  + _on_animation_player_animation_finished()
}
class N1 as "Sprites" <<(N,lightskyblue) Node2D>> {
}
class N2 as "Wire" <<(S,lightskyblue) Sprite2D>> {
}
class N3 as "Platform" <<(S,lightskyblue) Sprite2D>> {
}
class N4 as "Area2D" <<(A,lightskyblue) Area2D>> {
}
class N5 as "CollisionShape2D" <<(C,lightskyblue) CollisionShape2D>> {
}
class N6 as "StaticBody2D" <<(S,lightskyblue) StaticBody2D>> {
}
class N7 as "CollisionShape2D" <<(C,lightskyblue) CollisionShape2D>> {
}
class N8 as "AnimationPlayer" <<(A,yellow) AnimationPlayer>> {
}
R --o N1
R --o N8
N1 --o N2
N1 --o N3
N3 --o N4
N3 --o N6
N4 --o N5
N6 --o N7
!define _(a,b) a <-[#blue,thickness=2]- b
left to right direction
_(R::_on_area_2d_area_entered, N4::area_entered)
_(R::_on_area_2d_area_exited, N4::area_exited)
_(R::_on_animation_player_animation_finished, N8::animation_finished)
....


[.scene-assets]
=== Assets
[.asset-image]
[link=/assets/assets/images/stages/gimmicks/Pulley.png]
image::/assets/raw/assets/images/stages/gimmicks/Pulley.png[200, 100] 



=== Overridden virtual functions
==== _ready
```gdscript
func _ready() -> void:
	set_prev_position()
```
==== _physics_process
```gdscript
func _physics_process(_delta: float) -> void:
	if player and player.state != Player.State.FAILED:
		var diff = %Platform.global_position - prev_position
		player.global_position += diff
	set_prev_position()
```


=== Instantiators
* link:/scenes/src/chapters/1/chapter1.tscn[res://src/chapters/1/chapter1.tscn]


=== Scene Tree
[.scene-tree]
* [.node-name.type-2d]#Pulley# [.node-type.type-2d]#Node2D#
** [.node-name.type-2d]#Sprites# [.node-type.type-2d]#Node2D#
*** [.node-name.type-2d]#Wire# [.node-type.type-2d]#Sprite2D#
*** [.node-name.type-2d]#Platform# [.node-type.type-2d]#Sprite2D#
**** [.node-name.type-2d]#Area2D# [.node-type.type-2d]#Area2D#
***** [.node-name.type-2d]#CollisionShape2D# [.node-type.type-2d]#CollisionShape2D#
**** [.node-name.type-2d]#StaticBody2D# [.node-type.type-2d]#StaticBody2D#
***** [.node-name.type-2d]#CollisionShape2D# [.node-type.type-2d]#CollisionShape2D#
** [.node-name.type-other]#AnimationPlayer# [.node-type.type-other]#AnimationPlayer#


=== Signal Connections
[.signal-connection]
.$Sprites/Platform/Area2D:[#_area_entered_#]=>$.
```gdscript
func _on_area_2d_area_entered(area: Area2D) -> void:
	player = area.owner as Player
	if state == State.IDLE: move()
```
[.signal-connection]
.$Sprites/Platform/Area2D:[#_area_exited_#]=>$.
```gdscript
func _on_area_2d_area_exited(_area: Area2D) -> void:
	player = null
	if state == State.MOVED: rewind()
```
[.signal-connection]
.$AnimationPlayer:[#_animation_finished_#]=>$.
```gdscript
func _on_animation_player_animation_finished(anim_name: StringName) -> void:
	match anim_name:
		&'move': rewind()
		&'rewind': if player: move()
```


=== Animations
==== move

[plantuml]
....
control "Root" as R
participant "$Sprites\n/Platform" as T0 #87CEFA



== Time: 0.0 ==
R  ->  T0 : position\n = Vector2(0, 0)
R  ->o  R : state\n = 1
== Time: 0.76666665 ==
R  ->o  R : &"unlaunchable"()
== Time: 0.9 ==
R  ->  T0 : position\n = Vector2(72.4, -10.8)
== Time: 1.0 ==
R  ->  T0 : position\n = Vector2(71.4, -10.599999)
R  ->o  R : state\n = 2
== Time: 1.1 ==
R  ->o  R : &"unlaunchable"()


....
---

==== Animation_4wfbi

[plantuml]
....
control "Root" as R
participant "$Sprites\n/Platform" as T0 #87CEFA



== Time: 0.0 ==
R  ->  T0 : position\n = Vector2(0, 0)
R  ->o  R : state\n = 0


....
---

==== rewind

[plantuml]
....
control "Root" as R
participant "$Sprites\n/Platform" as T0 #87CEFA



== Time: 0.0 ==
R  ->  T0 : position\n = Vector2(71.4, -10.599999)
R  ->o  R : state\n = 1
== Time: 0.9 ==
R  ->  T0 : position\n = Vector2(-0.8, 0.2)
== Time: 1.0 ==
R  ->  T0 : position\n = Vector2(0, 0)
R  ->o  R : state\n = 0


....
---



=== Properties
[.node-property.node-2d]
.#Root# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*script* a|link:/scripts/src/stages/gimmicks/pulley/pulley.gd[res://src/stages/gimmicks/pulley/pulley.gd]
|===
[.node-property.node-2d]
.#$Sprites# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*scale* a|`Vector2(7, 7)`
|===
[.node-property.node-2d]
.#$Sprites/Wire# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*position* a|`Vector2(34.600002, -4.4000006)`
|*rotation* a|`-0.15687567`
|*texture* a|[link=/assets/assets/images/stages/gimmicks/Pulley.png]
[.asset-image]
.res://assets/images/stages/gimmicks/Pulley.png
image::/assets/raw/assets/images/stages/gimmicks/Pulley.png[]

|*region_enabled* a|`true`
|*region_rect* a|`Rect2(17, 0, 83, 12)`
|===
[.node-property.node-2d]
.#$Sprites/Platform# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*unique_name_in_owner* a|`true`
|*texture* a|[link=/assets/assets/images/stages/gimmicks/Pulley.png]
[.asset-image]
.res://assets/images/stages/gimmicks/Pulley.png
image::/assets/raw/assets/images/stages/gimmicks/Pulley.png[]

|*region_enabled* a|`true`
|*region_rect* a|`Rect2(0, 0, 17, 12)`
|===
[.node-property.node-2d]
.#$Sprites/Platform/Area2D# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*scale* a|`Vector2(0.19999999, 0.19999999)`
|*collision_layer* a|`0`
|*collision_mask* a|`2`
|===
[.node-property.node-2d]
.#$Sprites/Platform/Area2D/CollisionShape2D# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*position* a|`Vector2(-0.5, -30)`
|*shape* a|`SubResource("RectangleShape2D_4wfbi")`
|===
[.node-property.node-2d]
.#$Sprites/Platform/StaticBody2D# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*visible* a|`false`
|*position* a|`Vector2(0.2000032, -0.59999996)`
|*scale* a|`Vector2(0.99999994, 0.99999994)`
|===
[.node-property.node-2d]
.#$Sprites/Platform/StaticBody2D/CollisionShape2D# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*position* a|`Vector2(-2.7537344e-06, 0.50000036)`
|*scale* a|`Vector2(0.99999976, 0.99999976)`
|*shape* a|`SubResource("RectangleShape2D_75xxw")`
|===
[.node-property.node-other]
.#$AnimationPlayer# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*unique_name_in_owner* a|`true`
|*libraries* a|`{
&"": SubResource("AnimationLibrary_4wfbi")
}`
|===


=== link:/scripts/src/stages/gimmicks/pulley/pulley.gd[pulley.gd]

```gdscript
extends Node2D

enum State { IDLE, MOVING, MOVED }
@export var state : State = State.IDLE
@export var force := Vector2(4000, 0)
@onready var player : Player = null
var prev_position : Vector2


func _ready() -> void:
	set_prev_position()


func set_prev_position() -> void:
	prev_position = %Platform.global_position


func _physics_process(_delta: float) -> void:
	if player and player.state != Player.State.FAILED:
		var diff = %Platform.global_position - prev_position
		player.global_position += diff
	set_prev_position()


func reset() -> void:
	play(&'RESET')
	unlaunchable()


func move() -> void:
	play(&'move')


func rewind() -> void:
	play(&'rewind')


func launchable() -> void:
	if player: player.jump_boost = force


func unlaunchable() -> void:
	if player: player.jump_boost = Vector2(0, 0)


func play(key: StringName) -> void:
	%AnimationPlayer.play(key)


func _on_area_2d_area_entered(area: Area2D) -> void:
	player = area.owner as Player
	if state == State.IDLE: move()


func _on_area_2d_area_exited(_area: Area2D) -> void:
	player = null
	if state == State.MOVED: rewind()


func _on_animation_player_animation_finished(anim_name: StringName) -> void:
	match anim_name:
		&'move': rewind()
		&'rewind': if player: move()

```


