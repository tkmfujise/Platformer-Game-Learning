---
title: src/stages/gimmicks/pulley/pulley.tscn
---
:toc:

== src / stages / gimmicks / pulley / pulley.tscn

=== Diagram
[plantuml]
....
class R as "Pulley" <<(N,lightskyblue) Node2D>> {
  - DISTANCE
  * state
  * angle
  * move_time
  * force
  * player
  * direction
  * initial_position
  * prev_position
  * target_position
  * position_tween
---
  + _ready()
  + set_target()
  + set_initial_position()
  + set_prev_position()
  + _physics_process()
  + reset()
  + kill_position_tween()
  + recreate_position_tween()
  + move()
  + rewind()
  + launchable()
  + unlaunchable()
  + _on_area_2d_area_entered()
  + _on_area_2d_area_exited()
}
class N1 as "ResetOnPlayerRestart" <<(N,darkgray) Node>> {
---
  + _ready()
}
class N2 as "Sprites" <<(N,lightskyblue) Node2D>> {
}
class N3 as "Wire" <<(S,lightskyblue) Sprite2D>> {
}
class N4 as "Platform" <<(S,lightskyblue) Sprite2D>> {
}
class N5 as "Area2D" <<(A,lightskyblue) Area2D>> {
}
class N6 as "CollisionShape2D" <<(C,lightskyblue) CollisionShape2D>> {
}
class N7 as "StaticBody2D" <<(S,lightskyblue) StaticBody2D>> {
}
class N8 as "CollisionShape2D" <<(C,lightskyblue) CollisionShape2D>> {
}
R --o N1
R --o N2
N2 --o N3
N2 --o N4
N4 --o N5
N4 --o N7
N5 --o N6
N7 --o N8
!define _(a,b) a <-[#blue,thickness=2]- b
left to right direction
_(R::_on_area_2d_area_entered, N5::area_entered)
_(R::_on_area_2d_area_exited, N5::area_exited)
....


[.scene-assets]
=== Assets
[.asset-image]
[link=/assets/assets/images/stages/gimmicks/Pulley.png]
image::/assets/raw/assets/images/stages/gimmicks/Pulley.png[200, 100] 



=== Overridden virtual functions
==== _ready
```gdscript
func _ready() -> void:
	set_initial_position()
	set_target()
```
.$ResetOnPlayerRestart
```gdscript
func _ready() -> void:
	if owner and owner.has_method(&'reset'):
		GameEvent.player_restarted.connect(owner.reset)
```
==== _physics_process
```gdscript
func _physics_process(_delta: float) -> void:
	if player and player.state != Player.State.FAILED:
		var diff = %Platform.global_position - prev_position
		player.global_position += diff
		var distance = %Platform.global_position.distance_to(target_position)
		if state == State.MOVING && 10 < distance and distance < 70:
			launchable()
		else:
			unlaunchable()
	set_prev_position()
```


=== Instantiators
* link:/scenes/debug/gimmicks/pulley/pulley.tscn[res://debug/gimmicks/pulley/pulley.tscn]
* link:/scenes/src/chapters/1/chapter1.tscn[res://src/chapters/1/chapter1.tscn]


=== Scene Tree
[.scene-tree]
* [.node-name.type-2d]#Pulley# [.node-type.type-2d]#Node2D#
** [.node-name.type-plain]#ResetOnPlayerRestart# [.node-type.type-plain]#link:/scenes/src/mixins/reset_on_player_restart/reset_on_player_restart.tscn[res://src/mixins/reset_on_player_restart/reset_on_player_restart.tscn]#
** [.node-name.type-2d]#Sprites# [.node-type.type-2d]#Node2D#
*** [.node-name.type-2d]#Wire# [.node-type.type-2d]#Sprite2D#
*** [.node-name.type-2d]#Platform# [.node-type.type-2d]#Sprite2D#
**** [.node-name.type-2d]#Area2D# [.node-type.type-2d]#Area2D#
***** [.node-name.type-2d]#CollisionShape2D# [.node-type.type-2d]#CollisionShape2D#
**** [.node-name.type-2d]#StaticBody2D# [.node-type.type-2d]#StaticBody2D#
***** [.node-name.type-2d]#CollisionShape2D# [.node-type.type-2d]#CollisionShape2D#


=== Signal Connections
[.signal-connection]
.$Sprites/Platform/Area2D:[#_area_entered_#]=>$.
```gdscript
func _on_area_2d_area_entered(area: Area2D) -> void:
	player = area.owner as Player
	if state == State.IDLE: move()
```
[.signal-connection]
.$Sprites/Platform/Area2D:[#_area_exited_#]=>$.
```gdscript
func _on_area_2d_area_exited(_area: Area2D) -> void:
	player = null
```




=== Properties
[.node-property.node-2d]
.#Root# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*script* a|link:/scripts/src/stages/gimmicks/pulley/pulley.gd[res://src/stages/gimmicks/pulley/pulley.gd]
|*angle* a|`90`
|===
[.node-property.node-2d]
.#$Sprites# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*scale* a|`Vector2(7, 7)`
|===
[.node-property.node-2d]
.#$Sprites/Wire# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*unique_name_in_owner* a|`true`
|*texture* a|[link=/assets/assets/images/stages/gimmicks/Pulley.png]
[.asset-image]
.res://assets/images/stages/gimmicks/Pulley.png
image::/assets/raw/assets/images/stages/gimmicks/Pulley.png[]

|*offset* a|`Vector2(35, 0)`
|*region_enabled* a|`true`
|*region_rect* a|`Rect2(17, 0, 83, 12)`
|===
[.node-property.node-2d]
.#$Sprites/Platform# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*unique_name_in_owner* a|`true`
|*texture* a|[link=/assets/assets/images/stages/gimmicks/Pulley.png]
[.asset-image]
.res://assets/images/stages/gimmicks/Pulley.png
image::/assets/raw/assets/images/stages/gimmicks/Pulley.png[]

|*region_enabled* a|`true`
|*region_rect* a|`Rect2(0, 0, 17, 12)`
|===
[.node-property.node-2d]
.#$Sprites/Platform/Area2D# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*scale* a|`Vector2(0.19999999, 0.19999999)`
|*collision_layer* a|`0`
|*collision_mask* a|`2`
|===
[.node-property.node-2d]
.#$Sprites/Platform/Area2D/CollisionShape2D# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*position* a|`Vector2(-0.5, -30)`
|*shape* a|`SubResource("RectangleShape2D_4wfbi")`
|===
[.node-property.node-2d]
.#$Sprites/Platform/StaticBody2D# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*visible* a|`false`
|*position* a|`Vector2(0.2000032, -0.59999996)`
|*scale* a|`Vector2(0.99999994, 0.99999994)`
|===
[.node-property.node-2d]
.#$Sprites/Platform/StaticBody2D/CollisionShape2D# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*position* a|`Vector2(-2.7537344e-06, 0.50000036)`
|*scale* a|`Vector2(0.99999976, 0.99999976)`
|*shape* a|`SubResource("RectangleShape2D_75xxw")`
|===


=== link:/scripts/src/stages/gimmicks/pulley/pulley.gd[pulley.gd]

```gdscript
extends Node2D

enum State { IDLE, MOVING, REWINDING }
const DISTANCE := 480
@export var state : State = State.IDLE
@export_range(-180, 180) var angle : int = 0
@export var move_time : float = 0.5
@export var force : int = 3000
@onready var player : Player = null
var direction : Vector2
var initial_position : Vector2
var prev_position : Vector2
var target_position : Vector2
var position_tween : Tween


func _ready() -> void:
	set_initial_position()
	set_target()


func set_target() -> void:
	var rad = deg_to_rad(angle)
	%Wire.rotation = rad
	direction = Vector2(cos(rad), sin(rad))
	target_position = %Platform.global_position + direction * DISTANCE


func set_initial_position() -> void:
	initial_position = %Platform.global_position
	set_prev_position()


func set_prev_position() -> void:
	prev_position = %Platform.global_position


func _physics_process(_delta: float) -> void:
	if player and player.state != Player.State.FAILED:
		var diff = %Platform.global_position - prev_position
		player.global_position += diff
		var distance = %Platform.global_position.distance_to(target_position)
		if state == State.MOVING && 10 < distance and distance < 70:
			launchable()
		else:
			unlaunchable()
	set_prev_position()


func reset() -> void:
	state = State.IDLE
	player = null
	%Platform.position = Vector2()
	set_target()
	kill_position_tween()
	unlaunchable()


func kill_position_tween() -> void:
	if position_tween: position_tween.kill()


func recreate_position_tween(pos: Vector2, time: float) -> PropertyTweener:
	kill_position_tween()
	position_tween = create_tween()
	return position_tween.tween_property(%Platform,
		"global_position", pos, time)


func move() -> void:
	state = State.MOVING
	recreate_position_tween(target_position, move_time) \
		.set_ease(Tween.EASE_IN_OUT).set_trans(Tween.TRANS_BACK)
	position_tween.finished.connect(func():
		await get_tree().create_timer(1).timeout
		rewind())


func rewind() -> void:
	if not state == State.MOVING: return
	state = State.REWINDING
	recreate_position_tween(initial_position, move_time * 2) \
		.set_ease(Tween.EASE_IN).set_trans(Tween.TRANS_CUBIC)
	position_tween.finished.connect(func():
		await get_tree().create_timer(1).timeout
		state = State.IDLE
		if player: move())


func launchable() -> void:
	if player:
		player.jump_boost = force * direction


func unlaunchable() -> void:
	if player: player.jump_boost = Vector2(0, 0)


func _on_area_2d_area_entered(area: Area2D) -> void:
	player = area.owner as Player
	if state == State.IDLE: move()


func _on_area_2d_area_exited(_area: Area2D) -> void:
	player = null

```


