---
title: src/player/player.tscn
---
:toc:

== src / player / player.tscn

=== Diagram
[plantuml]
....
class R as "Player" <<(C,lightskyblue) CharacterBody2D>> {
  ~ dashed
  ~ jumped
  ~ landed
  ~ failed
  ~ reached
---
  - SPEED
  - DASH_SPEED
  - CLIMBING_SPEED
  - JUMP_VELOCITY
  - GRAVITY
  - ALLOWED_TIME_TO_JUMP
  - DASH_TIME
  - DASH_ATTENUATION
  - MAX_DASH_COUNT
  - MAX_CLIMBING_TIME
  - DEFAULT_SCALE
  * GhostEffect
  * LandedEffect
  * fatigue_curve
  * state
  * falling_time
  * dash_rest_time
  * dash_rest_count
  * climb_rest_time
  * sprite_tween
  * restart_position
  * jump_boost
  * last_owner_name
  * playable
---
  + _ready()
  + _physics_process()
  + compute_state()
  + may_drop_collisions()
  + is_just_input_action()
  + is_input_action()
  + animate()
  + animate_with()
  + compute_dashed()
  + idle()
  + walk_right()
  + walk_left()
  + turn_right()
  + turn_left()
  + restart()
  + dash()
  + lock()
  + unlock()
  + vibrate()
  + get_state_by()
  + tween_sprite()
  + update_sprite_states_shader_parameters()
  + spawn_ghost_effect()
  + current_sprite_state()
  + is_dashed()
  + _on_dashed()
  + _on_jumped()
  + _on_landed()
  + _on_failed()
  + _on_reached()
  + _on_frame_subject_area_entered()
  + _on_frame_subject_area_exited()
  + _on_area_collision_area_entered()
}
class N1 as "CanvasLayer" <<(C,yellow) CanvasLayer>> {
}
class N2 as "OpeningCurtain" <<(C,lightgreen) Control>> {
  ~ animation_finished
---
  * pattern
  * center
---
  + set_center()
  + play()
  + _on_animation_player_animation_finished()
}
class N3 as "RestartCurtain" <<(C,lightgreen) Control>> {
  ~ animation_finished
---
  * pattern
  * center
---
  + set_center()
  + play()
  + _on_animation_player_animation_finished()
}
class N4 as "Sprites" <<(N,lightskyblue) Node2D>> {
}
class N5 as "SpriteStates" <<(N,lightskyblue) Node2D>> {
}
class N6 as "IdleSprite2D" <<(S,lightskyblue) Sprite2D>> {
}
class N7 as "RunSprite2D" <<(S,lightskyblue) Sprite2D>> {
}
class N8 as "JumpSprite2D" <<(S,lightskyblue) Sprite2D>> {
}
class N9 as "FallSprite2D" <<(S,lightskyblue) Sprite2D>> {
}
class N10 as "ClimbSprite2D" <<(S,lightskyblue) Sprite2D>> {
}
class N11 as "SpriteEffects" <<(N,lightskyblue) Node2D>> {
}
class N12 as "BurstSprite2D" <<(S,lightskyblue) Sprite2D>> {
}
class N13 as "SweatSprite2D" <<(A,lightskyblue) AnimatedSprite2D>> {
}
class N14 as "CollisionShape2D" <<(C,lightskyblue) CollisionShape2D>> {
}
class N15 as "AreaCollision" <<(A,lightskyblue) Area2D>> {
}
class N16 as "CollisionShape2D" <<(C,lightskyblue) CollisionShape2D>> {
}
class N17 as "FrameSubject" <<(A,lightskyblue) Area2D>> {
}
class N18 as "CollisionShape2D" <<(C,lightskyblue) CollisionShape2D>> {
}
class N19 as "FrontRayCast" <<(R,lightskyblue) RayCast2D>> {
}
class N20 as "Camera" <<(C,lightskyblue) Camera2D>> {
  - DASH_SHAKING_TIME
  - FAILURE_SHAKING_TIME
  - SHAKING_VALUE
  * shaking_time
  * fixed_position
  * current_frames
  * shaking_value
---
  + _process()
  + add_frame()
  + remove_frame()
  + apply_limitation()
  + shake()
  + shaking()
}
class N21 as "AnimationPlayer" <<(A,yellow) AnimationPlayer>> {
}
class N22 as "AnimationTree" <<(A,yellow) AnimationTree>> {
}
R --o N1
R --o N4
R --o N14
R --o N15
R --o N17
R --o N19
R --o N20
R --o N21
R --o N22
N1 --o N2
N1 --o N3
N4 --o N5
N4 --o N11
N5 --o N6
N5 --o N7
N5 --o N8
N5 --o N9
N5 --o N10
N11 --o N12
N11 --o N13
N15 --o N16
N17 --o N18
!define _(a,b) a <-[#blue,thickness=2]- b
left to right direction
_(R::_on_dashed, R::dashed)
_(R::_on_failed, R::failed)
_(R::_on_jumped, R::jumped)
_(R::_on_landed, R::landed)
_(R::_on_reached, R::reached)
_(R::_on_area_collision_area_entered, N15::area_entered)
_(R::_on_frame_subject_area_entered, N17::area_entered)
_(R::_on_frame_subject_area_exited, N17::area_exited)
....


[.scene-assets]
=== Assets
[.asset-image]
[link=/assets/assets/images/player/effects/Sweat.png]
image::/assets/raw/assets/images/player/effects/Sweat.png[200, 100] 

[.asset-image]
[link=/assets/assets/images/player/Player_idle.png]
image::/assets/raw/assets/images/player/Player_idle.png[200, 100] 

[.asset-image]
[link=/assets/assets/images/player/Player_run.png]
image::/assets/raw/assets/images/player/Player_run.png[200, 100] 

[.asset-image]
[link=/assets/assets/images/player/Player_jump.png]
image::/assets/raw/assets/images/player/Player_jump.png[200, 100] 

[.asset-image]
[link=/assets/assets/images/player/Player_fall.png]
image::/assets/raw/assets/images/player/Player_fall.png[200, 100] 

[.asset-image]
[link=/assets/assets/images/player/Player_climb.png]
image::/assets/raw/assets/images/player/Player_climb.png[200, 100] 

[.asset-image]
[link=/assets/assets/images/player/effects/Burst.png]
image::/assets/raw/assets/images/player/effects/Burst.png[200, 100] 



=== Overridden virtual functions
==== _ready
```gdscript
func _ready() -> void:
	playable = true
	if not owner: return
	turn_right()
	if last_owner_name == owner.name:
		position = restart_position
	else:
		restart_position = position
	last_owner_name = owner.name
```
==== _physics_process
```gdscript
func _physics_process(delta: float) -> void:
	var dx := Input.get_axis(&'move_left', &'move_right')
	var dy := Input.get_axis(&'move_up', &'move_down')
	var direction := Vector2(dx, dy)
	var last_state := state
	state = compute_state(delta, direction)
	match state:
		State.CLIMBING:
			dx = 0
			velocity.y = dy * CLIMBING_SPEED
		State.DASHED:
			velocity = direction.normalized() * DASH_SPEED
		State.DASHING:
			velocity *= DASH_ATTENUATION * delta
		State.EXHAUSTED:
			dx = 0
		State.FAILED:
			velocity.x = lerp(velocity.x, 0.0, 0.2)
			velocity.y = lerp(velocity.y, 0.0, 0.2)
		State.FALLING:
			if last_state == State.CLIMBING \
			and dy < 0:
				velocity.y = JUMP_VELOCITY * 0.8
			else:
				var move_x := dx * SPEED * 0.8
				if velocity.x * dx < 0: move_x *= 0.1
				velocity.x = lerp(velocity.x, move_x, 0.2)
				
				if velocity.y < JUMP_VELOCITY * 0.85:
					velocity.y += GRAVITY * 1.45 * delta
				else:
					velocity.y += GRAVITY * 0.85 * delta
		State.JUMPED:
			velocity.y = JUMP_VELOCITY
		State.KICKED:
			velocity.y = JUMP_VELOCITY * 0.9
			velocity.x = get_wall_normal().x * DASH_SPEED * 0.4
		State.LOCKED:
			dx = 0
			velocity = Vector2(0, 0)
		_: pass
	
	if not playable: dx = 0
	if not (state == State.DASHED \
		or state == State.DASHING \
		or state == State.FALLING \
		or state == State.KICKED
	):
		if dx: velocity.x = dx * SPEED
		else: velocity.x = move_toward(velocity.x, 0, SPEED*0.2)
	if state == State.JUMPED:
		velocity += jump_boost
		jump_boost = Vector2(0, 0)
	
	animate(playable)
	move_and_slide()
```
==== _process
.$Camera
```gdscript
func _process(delta: float) -> void:
	if shaking_time:
		shaking_time = maxf(0.0, shaking_time - delta)
		shaking()
```


=== Instantiators
* link:/scenes/debug/stages/basic/basic.tscn[res://debug/stages/basic/basic.tscn]
* link:/scenes/src/chapters/0/stages/0/stage_0.tscn[res://src/chapters/0/stages/0/stage_0.tscn]
* link:/scenes/src/chapters/1/chapter1.tscn[res://src/chapters/1/chapter1.tscn]
* link:/scenes/src/main.tscn[res://src/main.tscn]


=== Scene Tree
[.scene-tree]
* [.node-name.type-2d]#Player# [.node-type.type-2d]#CharacterBody2D#
** [.node-name.type-other]#CanvasLayer# [.node-type.type-other]#CanvasLayer#
*** [.node-name.type-control]#OpeningCurtain# [.node-type.type-control]#link:/scenes/src/curtain/opening/opening.tscn[res://src/curtain/opening/opening.tscn]#
*** [.node-name.type-control]#RestartCurtain# [.node-type.type-control]#link:/scenes/src/curtain/opening/opening.tscn[res://src/curtain/opening/opening.tscn]#
** [.node-name.type-2d]#Sprites# [.node-type.type-2d]#Node2D#
*** [.node-name.type-2d]#SpriteStates# [.node-type.type-2d]#Node2D#
**** [.node-name.type-2d]#IdleSprite2D# [.node-type.type-2d]#Sprite2D#
**** [.node-name.type-2d]#RunSprite2D# [.node-type.type-2d]#Sprite2D#
**** [.node-name.type-2d]#JumpSprite2D# [.node-type.type-2d]#Sprite2D#
**** [.node-name.type-2d]#FallSprite2D# [.node-type.type-2d]#Sprite2D#
**** [.node-name.type-2d]#ClimbSprite2D# [.node-type.type-2d]#Sprite2D#
*** [.node-name.type-2d]#SpriteEffects# [.node-type.type-2d]#Node2D#
**** [.node-name.type-2d]#BurstSprite2D# [.node-type.type-2d]#Sprite2D#
**** [.node-name.type-2d]#SweatSprite2D# [.node-type.type-2d]#AnimatedSprite2D#
** [.node-name.type-2d]#CollisionShape2D# [.node-type.type-2d]#CollisionShape2D#
** [.node-name.type-2d]#AreaCollision# [.node-type.type-2d]#Area2D#
*** [.node-name.type-2d]#CollisionShape2D# [.node-type.type-2d]#CollisionShape2D#
** [.node-name.type-2d]#FrameSubject# [.node-type.type-2d]#Area2D#
*** [.node-name.type-2d]#CollisionShape2D# [.node-type.type-2d]#CollisionShape2D#
** [.node-name.type-2d]#FrontRayCast# [.node-type.type-2d]#RayCast2D#
** [.node-name.type-2d]#Camera# [.node-type.type-2d]#link:/scenes/src/player/camera/camera.tscn[res://src/player/camera/camera.tscn]#
** [.node-name.type-other]#AnimationPlayer# [.node-type.type-other]#AnimationPlayer#
** [.node-name.type-other]#AnimationTree# [.node-type.type-other]#AnimationTree#


=== Signal Connections
[.signal-connection]
.$.:[#_dashed_#]=>$.
```gdscript
func _on_dashed() -> void:
	vibrate(&'Dashed')
	tween_sprite(&'dashed')
	%Camera.shake(&'dash')
```
[.signal-connection]
.$.:[#_failed_#]=>$.
```gdscript
func _on_failed() -> void:
	playable = false
	state = State.FAILED
	velocity *= -1
	%Camera.shake(&'failure')
	%AnimationTree.active = false
	%AnimationPlayer.play(&'burst')
	GameEvent.player_restarted.emit()
```
[.signal-connection]
.$.:[#_jumped_#]=>$.
```gdscript
func _on_jumped() -> void:
	tween_sprite(&'jumped')
```
[.signal-connection]
.$.:[#_landed_#]=>$.
```gdscript
func _on_landed() -> void:
	vibrate(&'Landed')
	tween_sprite(&'landed')
	var effect = LandedEffect.instantiate()
	effect.spawn(self)
	idle()
```
[.signal-connection]
.$.:[#_reached_#]=>$.
```gdscript
func _on_reached(area: Area2D) -> void:
	restart_position = area.position
```
[.signal-connection]
.$AreaCollision:[#_area_entered_#]=>$.
```gdscript
func _on_area_collision_area_entered(area: Area2D) -> void:
	if area.get_collision_layer_value(4): # Failure
		failed.emit()
	elif area.get_collision_layer_value(6): # CheckPoint
		reached.emit(area)
```
[.signal-connection]
.$FrameSubject:[#_area_entered_#]=>$.
```gdscript
func _on_frame_subject_area_entered(area: Area2D) -> void:
	%Camera.add_frame(area)
```
[.signal-connection]
.$FrameSubject:[#_area_exited_#]=>$.
```gdscript
func _on_frame_subject_area_exited(area: Area2D) -> void:
	%Camera.remove_frame(area)
```


=== Animations
==== Animation_l271a

[plantuml]
....
control "Root" as R
participant "$Sprites\n/SpriteEffects\n/BurstSprite2D" as T0 #87CEFA
participant "$Sprites\n/SpriteStates" as T2 #87CEFA
participant "$Sprites\n/SpriteStates\n/ClimbSprite2D" as T3 #87CEFA
participant "$Sprites\n/SpriteEffects\n/SweatSprite2D" as T7 #87CEFA



== Time: 0.0 ==
R  ->o  T0 : visible\n = false
R  ->o  T0 : frame\n = 11
R  ->  T2 : modulate\n = Color(1, 1, 1, 1)
R  ->o  T3 : visible\n = false
R  ->o  T3 : flip_h\n = false
R  ->o  T3 : frame\n = 0
R  ->  T3 : offset\n = Vector2(2, 4)
R  ->o  T7 : visible\n = false
R  ->  T7 : position\n = Vector2(7.1666665, -8.166667)
R  ->o  T7 : flip_h\n = false


....
---

==== burst

[plantuml]
....
control "Root" as R
participant "$Sprites\n/SpriteEffects\n/BurstSprite2D" as T0 #87CEFA
participant "$Sprites\n/SpriteStates" as T2 #87CEFA



== Time: 0.0 ==
R  ->  T2 : modulate\n = Color(1, 1, 1, 1)
== Time: 0.25 ==
R  ->  T2 : modulate\n = Color(14.814934, 14.814934, 14.814934, 1)
== Time: 0.4000001 ==
R  ->o  T0 : frame\n = 0
== Time: 0.45 ==
R  ->o  T0 : visible\n = true
== Time: 0.4500001 ==
R  ->o  T0 : frame\n = 1
== Time: 0.49 ==
R  ->o  T0 : frame\n = 2
== Time: 0.5000001 ==
R  ->o  T0 : frame\n = 2
== Time: 0.55 ==
R  ->o  T0 : frame\n = 3
== Time: 0.6 ==
R  ->o  T0 : frame\n = 4
R  ->  T2 : modulate\n = Color(14.814934, 14.814934, 14.814934, 0)
== Time: 0.65000004 ==
R  ->o  T0 : frame\n = 5
== Time: 0.7 ==
R  ->o  T0 : frame\n = 6
== Time: 0.75 ==
R  ->o  T0 : frame\n = 7
== Time: 0.8 ==
R  ->o  T0 : frame\n = 8
== Time: 0.85 ==
R  ->o  T0 : frame\n = 9
== Time: 0.90000004 ==
R  ->o  T0 : frame\n = 10
== Time: 0.95 ==
R  ->o  T0 : frame\n = 11
== Time: 1.0 ==
R  ->o  T0 : frame\n = 12
== Time: 1.0500001 ==
R  ->o  T0 : frame\n = 13
== Time: 1.1 ==
R  ->o  T0 : frame\n = 14
== Time: 1.15 ==
R  ->o  T0 : frame\n = 15
== Time: 1.2 ==
R  ->o  T0 : frame\n = 16
== Time: 1.25 ==
R  ->o  T0 : frame\n = 17
== Time: 1.3000001 ==
R  ->o  T0 : frame\n = 18
== Time: 1.35 ==
R  ->o  T0 : frame\n = 19
== Time: 1.4 ==
R  ->o  T0 : frame\n = 20
== Time: 1.45 ==
R  ->o  T0 : frame\n = 21
== Time: 1.5 ==
R  ->o  T0 : frame\n = 22
== Time: 1.5500001 ==
R  ->o  T0 : frame\n = 23
== Time: 1.6 ==
R  ->o  T0 : frame\n = 24
== Time: 1.65 ==
R  ->o  T0 : frame\n = 25
== Time: 1.7 ==
R  ->o  T0 : frame\n = 26
== Time: 1.75 ==
R  ->o  T0 : frame\n = 27
== Time: 1.8000001 ==
R  ->o  T0 : frame\n = 28
== Time: 1.85 ==
R  ->o  T0 : frame\n = 29
== Time: 1.9 ==
R  ->o  T0 : frame\n = 30
== Time: 1.95 ==
R  ->o  T0 : frame\n = 31
== Time: 2.0 ==
R  ->o  T0 : frame\n = 32
== Time: 2.05 ==
R  ->o  T0 : frame\n = 33
== Time: 2.1000001 ==
R  ->o  T0 : frame\n = 34
== Time: 2.15 ==
R  ->o  T0 : frame\n = 35
== Time: 2.2 ==
R  ->o  T0 : frame\n = 36
== Time: 2.25 ==
R  ->o  T0 : frame\n = 37
R  ->o  R : &"restart"()
== Time: 2.3 ==
R  ->o  T0 : frame\n = 38
== Time: 2.3500001 ==
R  ->o  T0 : frame\n = 39
== Time: 2.4 ==
R  ->o  T0 : frame\n = 40
== Time: 2.45 ==
R  ->o  T0 : frame\n = 41
== Time: 2.5 ==
R  ->o  T0 : frame\n = 42
== Time: 2.55 ==
R  ->o  T0 : frame\n = 43
== Time: 2.6000001 ==
R  ->o  T0 : frame\n = 44
== Time: 2.65 ==
R  ->o  T0 : frame\n = 45
== Time: 2.7 ==
R  ->o  T0 : frame\n = 46
== Time: 2.75 ==
R  ->o  T0 : frame\n = 47
== Time: 2.8 ==
R  ->o  T0 : frame\n = 48
== Time: 2.8500001 ==
R  ->o  T0 : frame\n = 49
== Time: 2.9 ==
R  ->o  T0 : frame\n = 50
== Time: 2.95 ==
R  ->o  T0 : frame\n = 51
== Time: 3.0 ==
R  ->o  T0 : frame\n = 28
== Time: 3.05 ==
R  ->o  T0 : frame\n = 29
== Time: 3.1000001 ==
R  ->o  T0 : frame\n = 30
== Time: 3.15 ==
R  ->o  T0 : frame\n = 31
== Time: 3.2 ==
R  ->o  T0 : frame\n = 32
== Time: 3.25 ==
R  ->o  T0 : frame\n = 33
== Time: 3.3 ==
R  ->o  T0 : frame\n = 34
== Time: 3.3500001 ==
R  ->o  T0 : frame\n = 35
== Time: 3.4 ==
R  ->o  T0 : frame\n = 36
== Time: 3.45 ==
R  ->o  T0 : frame\n = 37
== Time: 3.5 ==
R  ->o  T0 : frame\n = 38
== Time: 3.55 ==
R  ->o  T0 : frame\n = 39
== Time: 3.6000001 ==
R  ->o  T0 : frame\n = 40
== Time: 3.65 ==
R  ->o  T0 : frame\n = 41
== Time: 3.7 ==
R  ->o  T0 : frame\n = 42
== Time: 3.75 ==
R  ->o  T0 : frame\n = 43
== Time: 3.8 ==
R  ->o  T0 : frame\n = 44
== Time: 3.8500001 ==
R  ->o  T0 : frame\n = 45
== Time: 3.9 ==
R  ->o  T0 : frame\n = 46
== Time: 3.95 ==
R  ->o  T0 : frame\n = 47
== Time: 4.0 ==
R  ->o  T0 : frame\n = 48
== Time: 4.05 ==
R  ->o  T0 : frame\n = 49
== Time: 4.1 ==
R  ->o  T0 : frame\n = 50
== Time: 4.15 ==
R  ->o  T0 : frame\n = 51
== Time: 4.2000003 ==
R  ->o  T0 : frame\n = 52
== Time: 4.25 ==
R  ->o  T0 : frame\n = 28
== Time: 4.3 ==
R  ->o  T0 : frame\n = 29
== Time: 4.35 ==
R  ->o  T0 : frame\n = 30
== Time: 4.4 ==
R  ->o  T0 : frame\n = 31
== Time: 4.4500003 ==
R  ->o  T0 : frame\n = 32
== Time: 4.5 ==
R  ->o  T0 : frame\n = 33
== Time: 4.55 ==
R  ->o  T0 : frame\n = 34
== Time: 4.6 ==
R  ->o  T0 : frame\n = 35
== Time: 4.65 ==
R  ->o  T0 : frame\n = 36
== Time: 4.7000003 ==
R  ->o  T0 : frame\n = 37
== Time: 4.75 ==
R  ->o  T0 : frame\n = 38
== Time: 4.8 ==
R  ->o  T0 : frame\n = 39
== Time: 4.85 ==
R  ->o  T0 : frame\n = 40
== Time: 4.9 ==
R  ->o  T0 : frame\n = 41
== Time: 4.9500003 ==
R  ->o  T0 : frame\n = 42
== Time: 5.0 ==
R  ->o  T0 : frame\n = 43


....
---

==== climb_left

[plantuml]
....
control "Root" as R
participant "$Sprites\n/SpriteStates\n/IdleSprite2D" as T0 #87CEFA
participant "$Sprites\n/SpriteStates\n/RunSprite2D" as T1 #87CEFA
participant "$Sprites" as T2 #87CEFA
participant "$Sprites\n/SpriteStates\n/FallSprite2D" as T3 #87CEFA
participant "$Sprites\n/SpriteStates\n/JumpSprite2D" as T4 #87CEFA
participant "$Sprites\n/SpriteStates\n/ClimbSprite2D" as T5 #87CEFA
participant "$Sprites\n/SpriteEffects\n/SweatSprite2D" as T9 #87CEFA


loop
== Time: 0.0 ==
R  ->o  T0 : visible\n = false
R  ->o  T1 : visible\n = false
R  ->  T2 : position\n = Vector2(12, -72)
R  ->o  T3 : visible\n = false
R  ->o  T4 : visible\n = false
R  ->o  T5 : visible\n = true
R  ->o  T5 : flip_h\n = false
R  ->o  T5 : frame\n = 0
R  ->  T5 : offset\n = Vector2(-6, 4)
R  ->o  T9 : visible\n = false
R  ->  T9 : position\n = Vector2(7, -12)
R  ->o  T9 : flip_h\n = false
== Time: 0.125 ==
R  ->o  T5 : frame\n = 1
== Time: 0.25 ==
R  ->o  T5 : frame\n = 2
R  ->o  T9 : visible\n = true
== Time: 0.375 ==
R  ->o  T5 : frame\n = 3
== Time: 0.5 ==
R  ->o  T5 : frame\n = 4
== Time: 1.0 ==
R  ->o  T5 : frame\n = 5

end
....
---

==== climb_right

[plantuml]
....
control "Root" as R
participant "$Sprites\n/SpriteStates\n/IdleSprite2D" as T0 #87CEFA
participant "$Sprites\n/SpriteStates\n/RunSprite2D" as T1 #87CEFA
participant "$Sprites" as T2 #87CEFA
participant "$Sprites\n/SpriteStates\n/FallSprite2D" as T3 #87CEFA
participant "$Sprites\n/SpriteStates\n/JumpSprite2D" as T4 #87CEFA
participant "$Sprites\n/SpriteStates\n/ClimbSprite2D" as T5 #87CEFA
participant "$Sprites\n/SpriteEffects\n/SweatSprite2D" as T9 #87CEFA


loop
== Time: 0.0 ==
R  ->o  T0 : visible\n = false
R  ->o  T1 : visible\n = false
R  ->  T2 : position\n = Vector2(12, -72)
R  ->o  T3 : visible\n = false
R  ->o  T4 : visible\n = false
R  ->o  T5 : visible\n = true
R  ->o  T5 : flip_h\n = true
R  ->o  T5 : frame\n = 0
R  ->  T5 : offset\n = Vector2(2, 4)
R  ->o  T9 : visible\n = false
R  ->  T9 : position\n = Vector2(-14, -12)
R  ->o  T9 : flip_h\n = true
== Time: 0.125 ==
R  ->o  T5 : frame\n = 1
== Time: 0.25 ==
R  ->o  T5 : frame\n = 2
R  ->o  T9 : visible\n = true
== Time: 0.375 ==
R  ->o  T5 : frame\n = 3
== Time: 0.5 ==
R  ->o  T5 : frame\n = 4
== Time: 1.0 ==
R  ->o  T5 : frame\n = 5

end
....
---

==== fall_left

[plantuml]
....
control "Root" as R
participant "$Sprites\n/SpriteStates\n/IdleSprite2D" as T0 #87CEFA
participant "$Sprites\n/SpriteStates\n/RunSprite2D" as T1 #87CEFA
participant "$Sprites" as T2 #87CEFA
participant "$Sprites\n/SpriteStates\n/JumpSprite2D" as T3 #87CEFA
participant "$Sprites\n/SpriteStates\n/FallSprite2D" as T4 #87CEFA
participant "$Sprites\n/SpriteStates\n/ClimbSprite2D" as T7 #87CEFA
participant "$Sprites\n/SpriteEffects\n/SweatSprite2D" as T8 #87CEFA


loop
== Time: 0.0 ==
R  ->o  T0 : visible\n = false
R  ->o  T1 : visible\n = false
R  ->  T2 : position\n = Vector2(-12, -72)
R  ->o  T3 : visible\n = false
R  ->o  T4 : visible\n = true
R  ->o  T4 : flip_h\n = false
R  ->o  T4 : frame\n = 0
R  ->o  T7 : visible\n = false
R  ->o  T8 : visible\n = false
== Time: 0.125 ==
R  ->o  T4 : frame\n = 1

end
....
---

==== fall_right

[plantuml]
....
control "Root" as R
participant "$Sprites\n/SpriteStates\n/IdleSprite2D" as T0 #87CEFA
participant "$Sprites\n/SpriteStates\n/RunSprite2D" as T1 #87CEFA
participant "$Sprites" as T2 #87CEFA
participant "$Sprites\n/SpriteStates\n/JumpSprite2D" as T3 #87CEFA
participant "$Sprites\n/SpriteStates\n/FallSprite2D" as T4 #87CEFA
participant "$Sprites\n/SpriteStates\n/ClimbSprite2D" as T7 #87CEFA
participant "$Sprites\n/SpriteEffects\n/SweatSprite2D" as T8 #87CEFA


loop
== Time: 0.0 ==
R  ->o  T0 : visible\n = false
R  ->o  T1 : visible\n = false
R  ->  T2 : position\n = Vector2(12, -72)
R  ->o  T3 : visible\n = false
R  ->o  T4 : visible\n = true
R  ->o  T4 : flip_h\n = true
R  ->o  T4 : frame\n = 0
R  ->o  T7 : visible\n = false
R  ->o  T8 : visible\n = false
== Time: 0.125 ==
R  ->o  T4 : frame\n = 1

end
....
---

==== idle_left

[plantuml]
....
control "Root" as R
participant "$Sprites\n/SpriteStates\n/RunSprite2D" as T0 #87CEFA
participant "$Sprites\n/SpriteStates\n/IdleSprite2D" as T1 #87CEFA
participant "$Sprites" as T4 #87CEFA
participant "$Sprites\n/SpriteStates\n/FallSprite2D" as T5 #87CEFA
participant "$Sprites\n/SpriteStates\n/JumpSprite2D" as T6 #87CEFA
participant "$Sprites\n/SpriteStates\n/ClimbSprite2D" as T7 #87CEFA
participant "$Sprites\n/SpriteEffects\n/SweatSprite2D" as T8 #87CEFA


loop
== Time: 0.0 ==
R  ->o  T0 : visible\n = false
R  ->o  T1 : visible\n = true
R  ->o  T1 : flip_h\n = false
R  ->o  T1 : frame\n = 0
R  ->  T4 : position\n = Vector2(-12, -72)
R  ->o  T5 : visible\n = false
R  ->o  T6 : visible\n = false
R  ->o  T7 : visible\n = false
R  ->o  T8 : visible\n = false
== Time: 0.2222 ==
R  ->o  T1 : frame\n = 1
== Time: 0.4444 ==
R  ->o  T1 : frame\n = 2
== Time: 0.6666 ==
R  ->o  T1 : frame\n = 3
== Time: 0.8888 ==
R  ->o  T1 : frame\n = 4
== Time: 1.111 ==
R  ->o  T1 : frame\n = 5
== Time: 1.3332 ==
R  ->o  T1 : frame\n = 6
== Time: 1.5554 ==
R  ->o  T1 : frame\n = 7
== Time: 1.7776 ==
R  ->o  T1 : frame\n = 8
== Time: 1.9998 ==
R  ->o  T1 : frame\n = 9
== Time: 2.222 ==
R  ->o  T1 : frame\n = 10
== Time: 2.4442 ==
R  ->o  T1 : frame\n = 11
== Time: 2.6664 ==
R  ->o  T1 : frame\n = 12
== Time: 2.8886 ==
R  ->o  T1 : frame\n = 13
== Time: 3.1108 ==
R  ->o  T1 : frame\n = 14
== Time: 3.333 ==
R  ->o  T1 : frame\n = 15
== Time: 3.5552 ==
R  ->o  T1 : frame\n = 16
== Time: 3.7774 ==
R  ->o  T1 : frame\n = 17
== Time: 3.9996 ==
R  ->o  T1 : frame\n = 18
== Time: 4.2218 ==
R  ->o  T1 : frame\n = 19
== Time: 4.444 ==
R  ->o  T1 : frame\n = 20
== Time: 4.6662 ==
R  ->o  T1 : frame\n = 21
== Time: 4.8884 ==
R  ->o  T1 : frame\n = 22
== Time: 5.1106 ==
R  ->o  T1 : frame\n = 23
== Time: 5.3328 ==
R  ->o  T1 : frame\n = 24
== Time: 5.555 ==
R  ->o  T1 : frame\n = 25

end
....
---

==== idle_right

[plantuml]
....
control "Root" as R
participant "$Sprites\n/SpriteStates\n/RunSprite2D" as T0 #87CEFA
participant "$Sprites\n/SpriteStates\n/IdleSprite2D" as T1 #87CEFA
participant "$Sprites" as T4 #87CEFA
participant "$Sprites\n/SpriteStates\n/JumpSprite2D" as T5 #87CEFA
participant "$Sprites\n/SpriteStates\n/ClimbSprite2D" as T6 #87CEFA
participant "$Sprites\n/SpriteEffects\n/SweatSprite2D" as T7 #87CEFA


loop
== Time: 0.0 ==
R  ->o  T0 : visible\n = false
R  ->o  T1 : visible\n = true
R  ->o  T1 : flip_h\n = true
R  ->o  T1 : frame\n = 0
R  ->  T4 : position\n = Vector2(12, -72)
R  ->o  T5 : visible\n = false
R  ->o  T6 : visible\n = false
R  ->o  T7 : visible\n = false
== Time: 0.2222 ==
R  ->o  T1 : frame\n = 1
== Time: 0.4444 ==
R  ->o  T1 : frame\n = 2
== Time: 0.6666 ==
R  ->o  T1 : frame\n = 3
== Time: 0.8888 ==
R  ->o  T1 : frame\n = 4
== Time: 1.111 ==
R  ->o  T1 : frame\n = 5
== Time: 1.3332 ==
R  ->o  T1 : frame\n = 6
== Time: 1.5554 ==
R  ->o  T1 : frame\n = 7
== Time: 1.7776 ==
R  ->o  T1 : frame\n = 8
== Time: 1.9998 ==
R  ->o  T1 : frame\n = 9
== Time: 2.222 ==
R  ->o  T1 : frame\n = 10
== Time: 2.4442 ==
R  ->o  T1 : frame\n = 11
== Time: 2.6664 ==
R  ->o  T1 : frame\n = 12
== Time: 2.8886 ==
R  ->o  T1 : frame\n = 13
== Time: 3.1108 ==
R  ->o  T1 : frame\n = 14
== Time: 3.333 ==
R  ->o  T1 : frame\n = 15
== Time: 3.5552 ==
R  ->o  T1 : frame\n = 16
== Time: 3.7774 ==
R  ->o  T1 : frame\n = 17
== Time: 3.9996 ==
R  ->o  T1 : frame\n = 18
== Time: 4.2218 ==
R  ->o  T1 : frame\n = 19
== Time: 4.444 ==
R  ->o  T1 : frame\n = 20
== Time: 4.6662 ==
R  ->o  T1 : frame\n = 21
== Time: 4.8884 ==
R  ->o  T1 : frame\n = 22
== Time: 5.1106 ==
R  ->o  T1 : frame\n = 23
== Time: 5.3328 ==
R  ->o  T1 : frame\n = 24
== Time: 5.555 ==
R  ->o  T1 : frame\n = 25

end
....
---

==== jump_left

[plantuml]
....
control "Root" as R
participant "$Sprites\n/SpriteStates\n/IdleSprite2D" as T0 #87CEFA
participant "$Sprites\n/SpriteStates\n/RunSprite2D" as T1 #87CEFA
participant "$Sprites" as T2 #87CEFA
participant "$Sprites\n/SpriteStates\n/JumpSprite2D" as T3 #87CEFA
participant "$Sprites\n/SpriteStates\n/FallSprite2D" as T4 #87CEFA
participant "$Sprites\n/SpriteStates\n/ClimbSprite2D" as T7 #87CEFA
participant "$Sprites\n/SpriteEffects\n/SweatSprite2D" as T8 #87CEFA


loop
== Time: 0.0 ==
R  ->o  T0 : visible\n = false
R  ->o  T1 : visible\n = false
R  ->  T2 : position\n = Vector2(-12, -72)
R  ->o  T3 : visible\n = true
R  ->o  T4 : visible\n = false
R  ->o  T3 : flip_h\n = false
R  ->o  T3 : frame\n = 0
R  ->o  T7 : visible\n = false
R  ->o  T8 : visible\n = false
== Time: 0.125 ==
R  ->o  T3 : frame\n = 1

end
....
---

==== jump_right

[plantuml]
....
control "Root" as R
participant "$Sprites\n/SpriteStates\n/IdleSprite2D" as T0 #87CEFA
participant "$Sprites\n/SpriteStates\n/RunSprite2D" as T1 #87CEFA
participant "$Sprites" as T2 #87CEFA
participant "$Sprites\n/SpriteStates\n/JumpSprite2D" as T3 #87CEFA
participant "$Sprites\n/SpriteStates\n/FallSprite2D" as T4 #87CEFA
participant "$Sprites\n/SpriteStates\n/ClimbSprite2D" as T7 #87CEFA
participant "$Sprites\n/SpriteEffects\n/SweatSprite2D" as T8 #87CEFA


loop
== Time: 0.0 ==
R  ->o  T0 : visible\n = false
R  ->o  T1 : visible\n = false
R  ->  T2 : position\n = Vector2(12, -72)
R  ->o  T3 : visible\n = true
R  ->o  T4 : visible\n = false
R  ->o  T3 : frame\n = 0
R  ->o  T3 : flip_h\n = true
R  ->o  T7 : visible\n = false
R  ->o  T8 : visible\n = false
== Time: 0.125 ==
R  ->o  T3 : frame\n = 1

end
....
---

==== run_left

[plantuml]
....
control "Root" as R
participant "$Sprites\n/SpriteStates\n/IdleSprite2D" as T0 #87CEFA
participant "$Sprites\n/SpriteStates\n/RunSprite2D" as T1 #87CEFA
participant "$Sprites" as T4 #87CEFA
participant "$Sprites\n/SpriteStates\n/JumpSprite2D" as T5 #87CEFA
participant "$Sprites\n/SpriteStates\n/FallSprite2D" as T6 #87CEFA
participant "$Sprites\n/SpriteStates\n/ClimbSprite2D" as T7 #87CEFA
participant "$Sprites\n/SpriteEffects\n/SweatSprite2D" as T8 #87CEFA


loop
== Time: 0.0 ==
R  ->o  T0 : visible\n = false
R  ->o  T1 : visible\n = true
R  ->o  T1 : flip_h\n = false
R  ->o  T1 : frame\n = 0
R  ->  T4 : position\n = Vector2(-12, -72)
R  ->o  T5 : visible\n = false
R  ->o  T6 : visible\n = false
R  ->o  T7 : visible\n = false
R  ->o  T8 : visible\n = false
== Time: 0.125 ==
R  ->o  T1 : frame\n = 1
== Time: 0.25 ==
R  ->o  T1 : frame\n = 2
== Time: 0.375 ==
R  ->o  T1 : frame\n = 3
== Time: 0.5 ==
R  ->o  T1 : frame\n = 4
== Time: 0.625 ==
R  ->o  T1 : frame\n = 5
== Time: 0.75 ==
R  ->o  T1 : frame\n = 6

end
....
---

==== run_right

[plantuml]
....
control "Root" as R
participant "$Sprites\n/SpriteStates\n/IdleSprite2D" as T0 #87CEFA
participant "$Sprites\n/SpriteStates\n/RunSprite2D" as T1 #87CEFA
participant "$Sprites" as T4 #87CEFA
participant "$Sprites\n/SpriteStates\n/FallSprite2D" as T5 #87CEFA
participant "$Sprites\n/SpriteStates\n/JumpSprite2D" as T6 #87CEFA
participant "$Sprites\n/SpriteStates\n/ClimbSprite2D" as T7 #87CEFA
participant "$Sprites\n/SpriteEffects\n/SweatSprite2D" as T8 #87CEFA


loop
== Time: 0.0 ==
R  ->o  T0 : visible\n = false
R  ->o  T1 : visible\n = true
R  ->o  T1 : flip_h\n = true
R  ->o  T1 : frame\n = 0
R  ->  T4 : position\n = Vector2(12, -72)
R  ->o  T5 : visible\n = false
R  ->o  T6 : visible\n = false
R  ->o  T7 : visible\n = false
R  ->o  T8 : visible\n = false
== Time: 0.125 ==
R  ->o  T1 : frame\n = 1
== Time: 0.25 ==
R  ->o  T1 : frame\n = 2
== Time: 0.375 ==
R  ->o  T1 : frame\n = 3
== Time: 0.5 ==
R  ->o  T1 : frame\n = 4
== Time: 0.625 ==
R  ->o  T1 : frame\n = 5
== Time: 0.75 ==
R  ->o  T1 : frame\n = 6

end
....
---



=== Properties
[.node-property.node-2d]
.#Root# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*collision_layer* a|`3`
|*collision_mask* a|`17`
|*script* a|link:/scripts/src/player/player.gd[res://src/player/player.gd]
|*GhostEffect* a|link:/scenes/src/player/ghost_effect/ghost_effect.tscn[res://src/player/ghost_effect/ghost_effect.tscn]
|*LandedEffect* a|link:/scenes/src/player/landed_effect/landed_effect.tscn[res://src/player/landed_effect/landed_effect.tscn]
|*fatigue_curve* a|`SubResource("Curve_ylhto")`
|===
[.node-property.node-control]
.#$CanvasLayer/OpeningCurtain# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*unique_name_in_owner* a|`true`
|*pattern* a|`2`
|===
[.node-property.node-control]
.#$CanvasLayer/RestartCurtain# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*unique_name_in_owner* a|`true`
|*pattern* a|`3`
|===
[.node-property.node-2d]
.#$Sprites# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*unique_name_in_owner* a|`true`
|*position* a|`Vector2(-12, -72)`
|*scale* a|`Vector2(6, 6)`
|===
[.node-property.node-2d]
.#$Sprites/SpriteStates# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*unique_name_in_owner* a|`true`
|===
[.node-property.node-2d]
.#$Sprites/SpriteStates/IdleSprite2D# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*material* a|`SubResource("ShaderMaterial_jm5te")`
|*texture* a|[link=/assets/assets/images/player/Player_idle.png]
[.asset-image]
.res://assets/images/player/Player_idle.png
image::/assets/raw/assets/images/player/Player_idle.png[]

|*hframes* a|`27`
|*frame* a|`6`
|===
[.node-property.node-2d]
.#$Sprites/SpriteStates/RunSprite2D# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*visible* a|`false`
|*material* a|`SubResource("ShaderMaterial_c3wmo")`
|*texture* a|[link=/assets/assets/images/player/Player_run.png]
[.asset-image]
.res://assets/images/player/Player_run.png
image::/assets/raw/assets/images/player/Player_run.png[]

|*hframes* a|`8`
|===
[.node-property.node-2d]
.#$Sprites/SpriteStates/JumpSprite2D# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*visible* a|`false`
|*material* a|`SubResource("ShaderMaterial_osywq")`
|*texture* a|[link=/assets/assets/images/player/Player_jump.png]
[.asset-image]
.res://assets/images/player/Player_jump.png
image::/assets/raw/assets/images/player/Player_jump.png[]

|*hframes* a|`2`
|===
[.node-property.node-2d]
.#$Sprites/SpriteStates/FallSprite2D# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*visible* a|`false`
|*material* a|`SubResource("ShaderMaterial_jpi3j")`
|*texture* a|[link=/assets/assets/images/player/Player_fall.png]
[.asset-image]
.res://assets/images/player/Player_fall.png
image::/assets/raw/assets/images/player/Player_fall.png[]

|*hframes* a|`2`
|===
[.node-property.node-2d]
.#$Sprites/SpriteStates/ClimbSprite2D# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*visible* a|`false`
|*material* a|`SubResource("ShaderMaterial_jpi3j")`
|*scale* a|`Vector2(0.8, 0.8)`
|*texture* a|[link=/assets/assets/images/player/Player_climb.png]
[.asset-image]
.res://assets/images/player/Player_climb.png
image::/assets/raw/assets/images/player/Player_climb.png[]

|*offset* a|`Vector2(2, 4)`
|*hframes* a|`6`
|===
[.node-property.node-2d]
.#$Sprites/SpriteEffects# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*unique_name_in_owner* a|`true`
|*position* a|`Vector2(2.1666667, 4)`
|===
[.node-property.node-2d]
.#$Sprites/SpriteEffects/BurstSprite2D# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*visible* a|`false`
|*position* a|`Vector2(-1.6666666, -2.8333335)`
|*texture* a|[link=/assets/assets/images/player/effects/Burst.png]
[.asset-image]
.res://assets/images/player/effects/Burst.png
image::/assets/raw/assets/images/player/effects/Burst.png[]

|*hframes* a|`53`
|*frame* a|`11`
|===
[.node-property.node-2d]
.#$Sprites/SpriteEffects/SweatSprite2D# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*visible* a|`false`
|*position* a|`Vector2(7.1666665, -8.166667)`
|*sprite_frames* a|`SubResource("SpriteFrames_jcdrv")`
|*autoplay* a|`default`
|*frame_progress* a|`0.8250497`
|===
[.node-property.node-2d]
.#$CollisionShape2D# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*position* a|`Vector2(2, -51)`
|*shape* a|`SubResource("CapsuleShape2D_opnj4")`
|===
[.node-property.node-2d]
.#$AreaCollision# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*collision_layer* a|`18`
|*collision_mask* a|`40`
|===
[.node-property.node-2d]
.#$AreaCollision/CollisionShape2D# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*visible* a|`false`
|*position* a|`Vector2(0, -56)`
|*shape* a|`SubResource("CapsuleShape2D_l271a")`
|===
[.node-property.node-2d]
.#$FrameSubject# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*collision_layer* a|`4`
|*collision_mask* a|`4`
|===
[.node-property.node-2d]
.#$FrameSubject/CollisionShape2D# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*visible* a|`false`
|*position* a|`Vector2(3.5, -51.5)`
|*shape* a|`SubResource("RectangleShape2D_x42xx")`
|===
[.node-property.node-2d]
.#$FrontRayCast# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*unique_name_in_owner* a|`true`
|*position* a|`Vector2(0, -50)`
|*target_position* a|`Vector2(-35, 0)`
|===
[.node-property.node-2d]
.#$Camera# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*unique_name_in_owner* a|`true`
|*position* a|`Vector2(0, -46)`
|===
[.node-property.node-other]
.#$AnimationPlayer# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*unique_name_in_owner* a|`true`
|*libraries* a|`{
&"": SubResource("AnimationLibrary_u5nx7")
}`
|===
[.node-property.node-other]
.#$AnimationTree# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*unique_name_in_owner* a|`true`
|*root_node* a|`NodePath("%AnimationTree/..")`
|*tree_root* a|`SubResource("AnimationNodeStateMachine_mwkb6")`
|*anim_player* a|`NodePath("../AnimationPlayer")`
|*parameters/Climb/blend_position* a|`-0.16339356`
|*parameters/Fall/blend_position* a|`-0.21995288`
|*parameters/Idle/blend_position* a|`-0.27003`
|*parameters/Jump/blend_position* a|`0.2168107`
|*parameters/Run/blend_position* a|`-0.7195601`
|===


=== link:/scripts/src/player/player.gd[player.gd]

```gdscript
extends CharacterBody2D
class_name Player

@export var GhostEffect : PackedScene
@export var LandedEffect : PackedScene
@export var fatigue_curve: Curve

signal dashed
signal jumped
signal landed
signal failed
signal reached(area: Area2D)

enum State {
	CLIMBING,
	DASHED,
	DASHING,
	EXHAUSTED,
	FAILED,
	FALLING,
	GROUNDING,
	JUMPED,
	KICKED,
	LOCKED,
}

const SPEED = 700.0
const DASH_SPEED = SPEED * 4
const CLIMBING_SPEED = SPEED / 6
const JUMP_VELOCITY = -1100.0
const GRAVITY = 3500
const ALLOWED_TIME_TO_JUMP = 0.13
const DASH_TIME = 0.1
const DASH_ATTENUATION = Vector2(55, 50)
const MAX_DASH_COUNT = 1
const MAX_CLIMBING_TIME = 7.0
const DEFAULT_SCALE = Vector2(6.0, 6.0)
var state : State = State.GROUNDING
var falling_time := 0.0
var dash_rest_time := 0.0
var dash_rest_count := MAX_DASH_COUNT
var climb_rest_time := 0.0
var sprite_tween : Tween
var restart_position : Vector2
var jump_boost : Vector2
static var last_owner_name : String
static var playable : bool = false


func _ready() -> void:
	playable = true
	if not owner: return
	turn_right()
	if last_owner_name == owner.name:
		position = restart_position
	else:
		restart_position = position
	last_owner_name = owner.name


func _physics_process(delta: float) -> void:
	var dx := Input.get_axis(&'move_left', &'move_right')
	var dy := Input.get_axis(&'move_up', &'move_down')
	var direction := Vector2(dx, dy)
	var last_state := state
	state = compute_state(delta, direction)
	match state:
		State.CLIMBING:
			dx = 0
			velocity.y = dy * CLIMBING_SPEED
		State.DASHED:
			velocity = direction.normalized() * DASH_SPEED
		State.DASHING:
			velocity *= DASH_ATTENUATION * delta
		State.EXHAUSTED:
			dx = 0
		State.FAILED:
			velocity.x = lerp(velocity.x, 0.0, 0.2)
			velocity.y = lerp(velocity.y, 0.0, 0.2)
		State.FALLING:
			if last_state == State.CLIMBING \
			and dy < 0:
				velocity.y = JUMP_VELOCITY * 0.8
			else:
				var move_x := dx * SPEED * 0.8
				if velocity.x * dx < 0: move_x *= 0.1
				velocity.x = lerp(velocity.x, move_x, 0.2)
				
				if velocity.y < JUMP_VELOCITY * 0.85:
					velocity.y += GRAVITY * 1.45 * delta
				else:
					velocity.y += GRAVITY * 0.85 * delta
		State.JUMPED:
			velocity.y = JUMP_VELOCITY
		State.KICKED:
			velocity.y = JUMP_VELOCITY * 0.9
			velocity.x = get_wall_normal().x * DASH_SPEED * 0.4
		State.LOCKED:
			dx = 0
			velocity = Vector2(0, 0)
		_: pass
	
	if not playable: dx = 0
	if not (state == State.DASHED \
		or state == State.DASHING \
		or state == State.FALLING \
		or state == State.KICKED
	):
		if dx: velocity.x = dx * SPEED
		else: velocity.x = move_toward(velocity.x, 0, SPEED*0.2)
	if state == State.JUMPED:
		velocity += jump_boost
		jump_boost = Vector2(0, 0)
	
	animate(playable)
	move_and_slide()


func compute_state(delta: float, direction: Vector2) -> State:
	if state == State.FAILED: return State.FAILED
	if state == State.LOCKED: return State.LOCKED
	if is_just_input_action(&'move_dash') \
	and dash_rest_count > 0 \
	and direction:
		compute_dashed()
		return State.DASHED
	elif dash_rest_time > 0:
		dash_rest_time -= delta
		return State.DASHING
	else:
		if not is_on_floor() and not state == State.CLIMBING:
			falling_time += delta
		else:
			if state == State.FALLING: landed.emit()
			falling_time = 0
			if not state == State.CLIMBING:
				dash_rest_count = MAX_DASH_COUNT
				if direction.y > 0: may_drop_collisions()
		
		var on_wall = %FrontRayCast.is_colliding()
		if is_just_input_action(&'move_jump') \
		and falling_time < ALLOWED_TIME_TO_JUMP:
			jumped.emit()
			return State.JUMPED
		elif is_just_input_action(&'move_jump') \
		and on_wall:
			jumped.emit()
			return State.KICKED
		elif on_wall and is_input_action(&'move_climb') \
		and (velocity.y >= 0 or state == State.CLIMBING) \
		and not (state == State.FALLING and falling_time < 0.2):
			falling_time = 0
			climb_rest_time -= delta
			if climb_rest_time > 0:
				return State.CLIMBING
			else:
				return State.EXHAUSTED
		
		if not is_on_floor():
			return State.FALLING
		else:
			climb_rest_time = MAX_CLIMBING_TIME
			return State.GROUNDING


func may_drop_collisions() -> void:
	for i in get_slide_collision_count():
		var collider = get_slide_collision(i).get_collider()
		if collider.is_in_group('droppable'):
			collider.drop()


func is_just_input_action(key: StringName) -> bool:
	return playable and state != State.EXHAUSTED \
		and Input.is_action_just_pressed(key)


func is_input_action(key: StringName) -> bool:
	return playable and state != State.EXHAUSTED \
		and Input.is_action_pressed(key)


func animate(force: bool = true) -> void:
	if state == State.LOCKED: return
	if force: animate_with(velocity)
	update_sprite_states_shader_parameters()
	if dash_rest_time > 0 && int(dash_rest_time*100)%3 > 0:
		spawn_ghost_effect()


func animate_with(_velocity: Vector2) -> void:
	if _velocity.x:
		%FrontRayCast.target_position.x = sign(_velocity.x) \
			* abs(%FrontRayCast.target_position.x)
		for st in ['Idle', 'Run', 'Jump', 'Fall', 'Climb']:
			%AnimationTree.set('parameters/%s/blend_position' % [st], _velocity.x)
	%AnimationTree.get('parameters/playback').travel(get_state_by(_velocity))


func compute_dashed() -> void:
	dashed.emit()
	dash_rest_time = DASH_TIME
	dash_rest_count -= 1


func idle() -> void:
	%AnimationPlayer.play(&'RESET')
	animate_with(Vector2(0, 0))


func walk_right() -> void:
	animate_with(Vector2(1, 0))


func walk_left() -> void:
	animate_with(Vector2(-1, 0))


func turn_right() -> void:
	walk_right(); idle()


func turn_left() -> void:
	walk_left(); idle()


func restart() -> void:
	%RestartCurtain.play()
	await get_tree().create_timer(1).timeout
	position = restart_position
	playable = true
	jump_boost = Vector2(0, 0)
	unlock()
	idle.call_deferred()


func dash(direction: Vector2) -> void:
	compute_dashed()
	state = State.DASHED
	velocity = direction.normalized() * DASH_SPEED
	

func lock() -> void:
	state = State.LOCKED
	%AnimationTree.active = false


func unlock() -> void:
	state = State.EXHAUSTED
	%AnimationTree.active = true


func vibrate(key: String):
	var values = [0, 0, 0]
	match key:
		&'Dashed': values = [0.4, 0.6, 0.2]
		&'Landed': values = [0.1, 0.3, 0.1]
	Input.start_joy_vibration(0, values[0], values[1], values[2])


func get_state_by(_velocity) -> String:
	if state == State.CLIMBING: return &'Climb'
	if _velocity:
		if _velocity.y < 0: return &'Jump'
		if _velocity.y > 0: return &'Fall'
		else: return &'Run'
	else: return &'Idle'


func tween_sprite(key: StringName) -> void:
	if sprite_tween: sprite_tween.kill()
	sprite_tween = %Sprites.create_tween()
	var coef = Vector2(1, 1)
	match key:
		&'dashed':
			var dir := velocity.normalized()
			coef = dir.abs().clamp(Vector2(0.75, 0.75), Vector2(1.0, 1.0))
		&'landed': coef = Vector2(1.08, 0.92)
		&'jumped': coef = Vector2(0.65, 1.45)

	sprite_tween.tween_property(%Sprites, 'scale', coef * DEFAULT_SCALE, 0.10) \
		.set_ease(Tween.EASE_IN_OUT).set_trans(Tween.TRANS_CUBIC)
	sprite_tween.tween_property(%Sprites, 'scale', DEFAULT_SCALE, 0.16) \
		.set_ease(Tween.EASE_OUT).set_trans(Tween.TRANS_SINE)


func update_sprite_states_shader_parameters() -> void:
	for sprite in %SpriteStates.get_children():
		sprite.material.set_shader_parameter(&'dashed', is_dashed())
		var fatigue = 0.0
		if state == State.CLIMBING:
			fatigue = fatigue_curve.sample(climb_rest_time / MAX_CLIMBING_TIME)
		sprite.material.set_shader_parameter(&'fatigue', fatigue)


func spawn_ghost_effect() -> void:
	var ghost = GhostEffect.instantiate()
	ghost.spawn(self)


func current_sprite_state() -> Sprite2D:
	return %SpriteStates.get_children().filter(
		func(c): return c.visible)[0]


func is_dashed() -> bool:
	return true if dash_rest_count < MAX_DASH_COUNT else false


func _on_dashed() -> void:
	vibrate(&'Dashed')
	tween_sprite(&'dashed')
	%Camera.shake(&'dash')


func _on_jumped() -> void:
	tween_sprite(&'jumped')


func _on_landed() -> void:
	vibrate(&'Landed')
	tween_sprite(&'landed')
	var effect = LandedEffect.instantiate()
	effect.spawn(self)
	idle()


func _on_failed() -> void:
	playable = false
	state = State.FAILED
	velocity *= -1
	%Camera.shake(&'failure')
	%AnimationTree.active = false
	%AnimationPlayer.play(&'burst')
	GameEvent.player_restarted.emit()


func _on_reached(area: Area2D) -> void:
	restart_position = area.position


func _on_frame_subject_area_entered(area: Area2D) -> void:
	%Camera.add_frame(area)


func _on_frame_subject_area_exited(area: Area2D) -> void:
	%Camera.remove_frame(area)


func _on_area_collision_area_entered(area: Area2D) -> void:
	if area.get_collision_layer_value(4): # Failure
		failed.emit()
	elif area.get_collision_layer_value(6): # CheckPoint
		reached.emit(area)

```


