---
title: src/dialogue/dialogue.tscn
---
:toc:

== src / dialogue / dialogue.tscn

=== Diagram
[plantuml]
....
class R as "Dialogue" <<(C,yellow) CanvasLayer>> {
  ~ finished
  ~ paused
  ~ event
---
  * boot_file
  * speakers
  * started
  * controller
  * current_speaker
  * waiting
---
  + _ready()
  + start()
  + continue_dialogue()
  + stop()
  + says()
  + set_speaker_image()
  + _input()
  + _handle()
  + _on_event()
  + _on_event_timer_timeout()
  + _on_paused()
  + _on_finished()
}
class N1 as "Background" <<(C,lightgreen) ColorRect>> {
}
class N2 as "LeftSpeaker" <<(C,lightgreen) CenterContainer>> {
}
class N3 as "LeftSpeakerImage" <<(S,lightskyblue) Sprite2D>> {
}
class N4 as "RightSpeaker" <<(C,lightgreen) CenterContainer>> {
}
class N5 as "RightSpeakerImage" <<(S,lightskyblue) Sprite2D>> {
}
class N6 as "Content" <<(R,lightgreen) RichTextLabel>> {
}
class N7 as "EventTimer" <<(T,yellow) Timer>> {
}
class N8 as "AnimationPlayer" <<(A,yellow) AnimationPlayer>> {
}
R --o N1
R --o N2
R --o N4
R --o N6
R --o N7
R --o N8
N2 --o N3
N4 --o N5
!define _(a,b) a <-[#blue,thickness=2]- b
left to right direction
_(R::_on_event, R::event)
_(R::_on_finished, R::finished)
_(R::_on_paused, R::paused)
_(R::_on_event_timer_timeout, N7::timeout)
....


[.scene-assets]
=== Assets
[.asset-image]
[link=/assets/assets/images/faces/actors/OldWoman_face.png]
image::/assets/raw/assets/images/faces/actors/OldWoman_face.png[200, 100] 



=== Overridden virtual functions
==== _ready
```gdscript
func _ready() -> void:
	controller.boot_file = boot_file
	controller.channel.connect(_handle)
```
==== _input
```gdscript
func _input(_event: InputEvent) -> void:
	if not started: return
	if waiting: return
	if _event.is_action_pressed('ui_accept'):
		continue_dialogue()
```


=== Instantiators
* link:/scenes/src/dialogue/chapters/0/stage0.tscn[res://src/dialogue/chapters/0/stage0.tscn]
* link:/scenes/src/dialogue/chapters/1/young_guy.tscn[res://src/dialogue/chapters/1/young_guy.tscn]


=== Scene Tree
[.scene-tree]
* [.node-name.type-other]#Dialogue# [.node-type.type-other]#CanvasLayer#
** [.node-name.type-control]#Background# [.node-type.type-control]#ColorRect#
** [.node-name.type-control]#LeftSpeaker# [.node-type.type-control]#CenterContainer#
*** [.node-name.type-2d]#LeftSpeakerImage# [.node-type.type-2d]#link:/scenes/src/dialogue/speaker/speaker.tscn[res://src/dialogue/speaker/speaker.tscn]#
** [.node-name.type-control]#RightSpeaker# [.node-type.type-control]#CenterContainer#
*** [.node-name.type-2d]#RightSpeakerImage# [.node-type.type-2d]#link:/scenes/src/dialogue/speaker/speaker.tscn[res://src/dialogue/speaker/speaker.tscn]#
** [.node-name.type-control]#Content# [.node-type.type-control]#RichTextLabel#
** [.node-name.type-other]#EventTimer# [.node-type.type-other]#Timer#
** [.node-name.type-other]#AnimationPlayer# [.node-type.type-other]#AnimationPlayer#


=== Signal Connections
[.signal-connection]
.$.:[#_event_#]=>$.
```gdscript
func _on_event(_event_name: String) -> void:
	current_speaker = ''
	%AnimationPlayer.play("hide")
```
[.signal-connection]
.$.:[#_finished_#]=>$.
```gdscript
func _on_finished() -> void:
	await stop()
	queue_free()
```
[.signal-connection]
.$.:[#_paused_#]=>$.
```gdscript
func _on_paused() -> void:
	waiting = true
	stop()
```
[.signal-connection]
.$EventTimer:[#_timeout_#]=>$.
```gdscript
func _on_event_timer_timeout() -> void:
	waiting = false
	continue_dialogue()
```


=== Animations
==== Animation_4gkn1

[plantuml]
....
control "Root" as R
participant "$LeftSpeaker" as T0 #90EE90
participant "$RightSpeaker" as T1 #90EE90
participant "$Background" as T2 #90EE90
participant "$Content" as T3 #90EE90
participant "$LeftSpeaker\n/LeftSpeakerImage" as T4 #87CEFA
participant "$RightSpeaker\n/RightSpeakerImage" as T5 #87CEFA



== Time: 0.0 ==
R  ->o  T0 : visible\n = true
R  ->o  T1 : visible\n = true
R  ->  T2 : size\n = Vector2(1870, 311)
R  ->o  T3 : visible\n = true
R  ->  T4 : scale\n = Vector2(1, 1)
R  ->  T5 : scale\n = Vector2(1, 1)


....
---

==== hide

[plantuml]
....
control "Root" as R
participant "$LeftSpeaker" as T0 #90EE90
participant "$RightSpeaker" as T1 #90EE90
participant "$Background" as T2 #90EE90
participant "$Content" as T3 #90EE90
participant "$LeftSpeaker\n/LeftSpeakerImage" as T4 #87CEFA
participant "$RightSpeaker\n/RightSpeakerImage" as T5 #87CEFA



== Time: 0.0 ==
R  ->o  T0 : visible\n = true
R  ->o  T1 : visible\n = true
R  ->  T2 : size\n = Vector2(1870, 311)
R  ->o  T3 : visible\n = false
R  ->  T4 : scale\n = Vector2(1, 1)
R  ->  T5 : scale\n = Vector2(1, 1)
== Time: 0.1 ==
R  ->o  T1 : visible\n = false
== Time: 0.25 ==
R  ->o  T0 : visible\n = false
R  ->  T4 : scale\n = Vector2(1e-05, 1e-05)
R  ->  T5 : scale\n = Vector2(0, 0)
== Time: 1.0 ==
R  ->  T2 : size\n = Vector2(1870, 0)


....
---

==== ready (autoplay)

[plantuml]
....
control "Root" as R
participant "$LeftSpeaker" as T0 #90EE90
participant "$RightSpeaker" as T1 #90EE90
participant "$Background" as T2 #90EE90
participant "$Content" as T3 #90EE90
participant "$LeftSpeaker\n/LeftSpeakerImage" as T4 #87CEFA
participant "$RightSpeaker\n/RightSpeakerImage" as T5 #87CEFA



== Time: 0.0 ==
R  ->o  T0 : visible\n = false
R  ->o  T1 : visible\n = false
R  ->  T2 : size\n = Vector2(1870, 0)
R  ->o  T3 : visible\n = false
R  ->  T4 : scale\n = Vector2(1, 1)
R  ->  T5 : scale\n = Vector2(1, 1)


....
---

==== show

[plantuml]
....
control "Root" as R
participant "$LeftSpeaker" as T0 #90EE90
participant "$RightSpeaker" as T1 #90EE90
participant "$Background" as T2 #90EE90
participant "$Content" as T3 #90EE90
participant "$LeftSpeaker\n/LeftSpeakerImage" as T4 #87CEFA
participant "$RightSpeaker\n/RightSpeakerImage" as T5 #87CEFA



== Time: 0.0 ==
R  ->o  T0 : visible\n = false
R  ->o  T1 : visible\n = false
R  ->  T2 : size\n = Vector2(1870, 0)
R  ->o  T3 : visible\n = false
== Time: 0.25 ==
R  ->o  T0 : visible\n = true
R  ->o  T1 : visible\n = true
R  ->  T4 : scale\n = Vector2(1e-05, 1e-05)
R  ->  T5 : scale\n = Vector2(0, 0)
== Time: 0.8 ==
R  ->o  T3 : visible\n = true
R  ->  T4 : scale\n = Vector2(1, 1)
R  ->  T5 : scale\n = Vector2(1, 1)
== Time: 1.0 ==
R  ->  T2 : size\n = Vector2(1870, 311)


....
---



=== Properties
[.node-property.node-other]
.#Root# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*script* a|link:/scripts/src/dialogue/dialogue.gd[res://src/dialogue/dialogue.gd]
|*boot_file* a|link:/assets/src/dialogue/scenarios/basic.rb[res://src/dialogue/scenarios/basic.rb]
|===
[.node-property.node-control]
.#$Background# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*offset_left* a|`25.0`
|*offset_top* a|`25.0`
|*offset_right* a|`1895.0`
|*offset_bottom* a|`336.0`
|*color* a|`Color(0.16482493, 0.11166973, 0.19798216, 1)`
|===
[.node-property.node-control]
.#$LeftSpeaker# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*offset_left* a|`66.0`
|*offset_top* a|`51.0`
|*offset_right* a|`329.0`
|*offset_bottom* a|`234.0`
|===
[.node-property.node-2d]
.#$LeftSpeaker/LeftSpeakerImage# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*unique_name_in_owner* a|`true`
|*flip_h* a|`true`
|===
[.node-property.node-control]
.#$RightSpeaker# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*anchors_preset* a|`1`
|*anchor_left* a|`1.0`
|*anchor_right* a|`1.0`
|*offset_left* a|`-263.0`
|*offset_bottom* a|`183.0`
|*grow_horizontal* a|`0`
|*size_flags_horizontal* a|`8`
|===
[.node-property.node-2d]
.#$RightSpeaker/RightSpeakerImage# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*unique_name_in_owner* a|`true`
|*position* a|`Vector2(-60, 53)`
|*texture* a|[link=/assets/assets/images/faces/actors/OldWoman_face.png]
[.asset-image]
.res://assets/images/faces/actors/OldWoman_face.png
image::/assets/raw/assets/images/faces/actors/OldWoman_face.png[]

|*hframes* a|`3`
|===
[.node-property.node-control]
.#$Content# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*unique_name_in_owner* a|`true`
|*anchors_preset* a|`5`
|*anchor_left* a|`0.5`
|*anchor_right* a|`0.5`
|*offset_left* a|`-580.5`
|*offset_top* a|`48.0`
|*offset_right* a|`580.5`
|*offset_bottom* a|`310.0`
|*grow_horizontal* a|`2`
|*size_flags_horizontal* a|`4`
|*size_flags_vertical* a|`4`
|*theme* a|link:/resources/themes/default_theme.tres[res://themes/default_theme.tres]
|*text* a|`This is test.`
|*vertical_alignment* a|`1`
|===
[.node-property.node-other]
.#$EventTimer# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*unique_name_in_owner* a|`true`
|*one_shot* a|`true`
|===
[.node-property.node-other]
.#$AnimationPlayer# properties
[cols="1,3" options="header"]
|===
|Name |Value
|*unique_name_in_owner* a|`true`
|*libraries* a|`{
&"": SubResource("AnimationLibrary_5m8cj")
}`
|*autoplay* a|`ready`
|===


=== link:/scripts/src/dialogue/dialogue.gd[dialogue.gd]

```gdscript
extends CanvasLayer

signal finished
signal paused
signal event(event_name: String)

@export_file_path("*.rb") var boot_file : String
@export var speakers : Array[DialogueSpeaker] = []
@onready var started : bool = false
@onready var controller := ReDScribe.new()
var current_speaker : String = ''
var waiting : bool = false


func _ready() -> void:
	controller.boot_file = boot_file
	controller.channel.connect(_handle)


func start() -> void:
	show()
	continue_dialogue()
	started = true
	waiting = false
	Player.playable = false


func continue_dialogue() -> void:
	controller.perform('continue')


func stop() -> void:
	current_speaker = ''
	%AnimationPlayer.play("hide")
	await get_tree().create_timer(1.0).timeout
	Player.playable = true


func says(
	speaker_name: String, content: String, position: StringName,
	face: String,
) -> void:
	if current_speaker != speaker_name:
		current_speaker = speaker_name
		%AnimationPlayer.play("show")
	if position == &'left':
		%LeftSpeakerImage.visible = true
		%RightSpeakerImage.visible = false
	else:
		%LeftSpeakerImage.visible = false
		%RightSpeakerImage.visible = true
	set_speaker_image(speaker_name, position, face)
	%Content.text = content


func set_speaker_image(speaker_name: String, position: StringName, face: String) -> void:
	var speaker_idx = speakers.find_custom(func(s):
		return s.speaker_name == speaker_name)
	if speaker_idx < 0: return
	var speaker = speakers[speaker_idx]
	var target = %LeftSpeakerImage if position == &'left' \
		else %RightSpeakerImage
	target.texture = speaker.texture
	target.hframes = speaker.faces.size() + 1
	var face_idx = speaker.faces.find(face)
	if face_idx >= 0:
		target.frame = face_idx + 1
	else:
		target.frame = 0


func _input(_event: InputEvent) -> void:
	if not started: return
	if waiting: return
	if _event.is_action_pressed('ui_accept'):
		continue_dialogue()


func _handle(key: StringName, payload: Variant) -> void:
	match key:
		&'says':
			var content = payload['content']
			if content is Array: content = "\n".join(content)
			says(payload['name'], content, payload['position'], payload['face'])
		&'event':
			event.emit(payload)
		&'wait':
			waiting = true
			%EventTimer.start(payload)
		&'paused':
			paused.emit()
		&'finished':
			finished.emit()
		_: print_debug("[%s]: %s" % [key, payload])


func _on_event(_event_name: String) -> void:
	current_speaker = ''
	%AnimationPlayer.play("hide")


func _on_event_timer_timeout() -> void:
	waiting = false
	continue_dialogue()


func _on_paused() -> void:
	waiting = true
	stop()


func _on_finished() -> void:
	await stop()
	queue_free()

```


